generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model LearningItem {
  id        String   @id @default(cuid())
  text      String
  subject   String
  createdAt DateTime @default(now())
}

model KnowledgeBaseItem {
  id           String   @id @default(cuid())
  name         String
  type         String
  size         Int
  lastModified BigInt
  text         String?
  ocrText      String?
  notes        String?
  dataUrl      String?
  include      Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("knowledge_base_items")
}

model LearningSession {
  id               String         @id @default(cuid())
  conversationId   String         @unique
  conversation     Conversation   @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId           String?        // Linked to UserProfile.id (Optional for migration)
  subject          String
  topic            String
  aiExplanation    String?
  socraticDialogue Json?
  currentStep      String         @default("EXPLAIN")
  isCompleted      Boolean        @default(false)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  coachingHistory  Json?
  feedback         String?
  finalScore       Int?
  grade            String?
  region           String?
  reviewNotes      String?
  aiSummary        String?
  quizQuestions    QuizQuestion[]
  userAnswers      UserAnswer[]

  @@index([subject, topic])
  @@index([createdAt])
  @@index([isCompleted])
  @@map("learning_sessions")
}

model QuizQuestion {
  id            String          @id @default(cuid())
  sessionId     String
  question      String
  type          String
  options       Json?
  correctAnswer String
  explanation   String?
  difficulty    String          @default("medium")
  points        Int             @default(1)
  order         Int
  createdAt     DateTime        @default(now())
  session       LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userAnswers   UserAnswer[]

  @@index([sessionId, order])
  @@map("quiz_questions")
}

model UserAnswer {
  id         String          @id @default(cuid())
  sessionId  String
  questionId String
  userAnswer String
  isCorrect  Boolean
  score      Int             @default(0)
  timeSpent  Int?
  answeredAt DateTime        @default(now())
  question   QuizQuestion    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  session    LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([questionId])
  @@index([isCorrect])
  @@map("user_answers")
}

model LearningStats {
  id              String   @id @default(cuid())
  conversationId  String   @unique
  userId          String?  // Linked to UserProfile.id
  totalQuestions  Int      @default(0)
  correctAnswers  Int      @default(0)
  totalScore      Int      @default(0)
  maxScore        Int      @default(0)
  accuracy        Float    @default(0)
  totalTimeSpent  Int      @default(0)
  explanationTime Int      @default(0)
  coachingTime    Int      @default(0)
  quizTime        Int      @default(0)
  weaknesses      Json?
  suggestions     Json?
  // Streak tracking fields
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastActiveDate  DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("learning_stats")
}

// --- RAG System Models ---

model KnowledgeChunk {
  id        String   @id @default(cuid())
  content   String
  // Use Unsupported type for pgvector. 
  // IMPORTANT: You must run `CREATE EXTENSION IF NOT EXISTS vector;` in your DB.
  // vector    Unsupported("vector(1536)")?
  
  // Metadata
  type      String   // ChunkType: SYLLABUS, EXAM_PROFILE, TEMPLATE, PITFALL
  subject   String
  grade     String?
  region    String?
  tags      String[] // Stored as array of strings
  
  createdAt DateTime @default(now())
  
  @@map("knowledge_chunks")
}

model LocalExamProfile {
  id        String   @id @default(cuid())
  region    String
  subject   String
  year      Int
  
  // JSON structure: { knowledgeDistribution: {}, questionTypeRatio: {}, bloomTaxonomy: {} }
  profileData Json
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([region, subject, year])
  @@map("local_exam_profiles")
}

model QuestionBank {
  id          String   @id @default(cuid())
  // Structure: { stem: string, options?: [], answer: string, analysis: string, points: number }
  content     Json
  hash        String   @unique // MD5 of content.stem to prevent duplicates
  
  subject     String
  grade       String
  region      String
  difficulty  Float
  knowledgePoints String[]
  
  qcStatus    String   @default("PENDING") // PENDING, PASSED, FAILED
  qcLog       Json?    // Array of QC check results
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("question_bank")
}

model QuestionQC {
  id            String   @id @default(cuid())
  questionId    String
  result        String   // PASS, FAIL
  checkType     String   // FORMAT, LOGIC, CONTENT_MODEL
  details       String?
  createdAt     DateTime @default(now())

  @@index([questionId])
  @@map("question_qc_runs")
}

// --- User System Models ---

model UserProfile {
  id        String   @id // Corresponds to Clerk User ID
  email     String   @unique
  name      String?
  grade     String?  
  region    String?  
  goals     String[]
  preferences Json?  // Learning preferences: { style: 'visual', difficulty: 'hard' }
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_profiles")
}

model Conversation {
  id            String   @id @default(cuid())
  userId        String
  title         String
  type          String   // 'learning' | 'general'
  messages      Json     // Array of ChatMessage
  
  // Metadata
  messageCount  Int      @default(0)
  lastActivity  DateTime @default(now())
  isArchived    Boolean  @default(false)
  tags          String[]
  
  // Learning specific
  subject       String?
  topic         String?
  aiExplanation String?  @db.Text
  
  // Relations
  learningSession LearningSession?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([lastActivity])
  @@map("conversations")
}

// --- Wrong Question Module ---

model WrongQuestion {
  id              String   @id @default(cuid())
  userId          String   // Linked to UserProfile.id

  subject         String
  question        String   @db.Text
  correctAnswer   String?  @db.Text
  userAnswer      String?  @db.Text
  analysis        String?  @db.Text
  source          String?
  tags            String[]
  imageUrls       String[]
  answerImageUrls String[]
  aiAnalysis      Json?
  knowledgePoints String[]
  relatedNotes    String[]
  relatedQuestions String[]
  stage           Int      @default(0)
  nextReviewAt    DateTime
  lastReviewedAt  DateTime?
  reviewHistory   Json?
  reviewCount     Int      @default(0)
  status          String   @default("active")
  isFavorite      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([subject])
  @@index([nextReviewAt])
  @@index([status])
  @@index([updatedAt])
  @@map("wrong_questions")
}

// --- Notes Module ---

model Note {
  id               String      @id @default(cuid())
  userId           String?     // Linked to UserProfile.id
  title            String
  icon             String?
  cover            String?
  backlinks        String[]
  forwardLinks     String[]
  knowledgePoints  String[]
  relatedQuestions String[]
  tags             String[]
  template         String?
  color            String      @default("#3b82f6")
  isFavorite       Boolean     @default(false)
  isArchived       Boolean     @default(false)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  blocks           NoteBlock[]

  @@index([updatedAt])
  @@index([isFavorite])
  @@index([isArchived])
  @@map("notes")
}

model NoteBlock {
  id         String   @id @default(cuid())
  noteId     String
  type       String
  content    String   @db.Text
  properties Json?
  order      Int
  parentId   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  note       Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([noteId, order])
  @@map("note_blocks")
}

// --- Intelligent Partner ---

model PartnerSession {
  id               String   @id @default(cuid())
  userId           String?  // 登录用户
  guestId          String?  // 游客标识

  mode             String   @default("Study") // Study | Work | Brainstorm
  topic            String?
  goal             String?

  pageUrl          String?
  pageTitle        String?
  pageDomain       String?
  contextSnippet   String?  @db.Text

  recentSignalsJson String? @db.Text // JSON string

  status           String   @default("draft") // draft | saved | archived

  messages         PartnerMessage[]
  assets           PartnerAsset[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
  @@index([guestId])
  @@index([status])
  @@index([pageDomain])
}

model PartnerMessage {
  id            String   @id @default(cuid())
  sessionId     String
  session       PartnerSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  role          String   // user | assistant
  content       String   @db.Text // 纯文本内容
  contentJson   String?  @db.Text // 结构化 JSON（tldr/reasoning/actions/citations）
  citationsJson String?  @db.Text // 引用 JSON

  createdAt     DateTime @default(now())

  @@index([sessionId])
}

model PartnerAsset {
  id             String   @id @default(cuid())
  sessionId      String
  session        PartnerSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  type           String   // insight | action | idea | risk | summary
  title          String
  contentJson    String   @db.Text // 资产内容 JSON
  actionItemsJson String? @db.Text // 行动项（带 checked 状态）
  citationsJson  String?  @db.Text

  status         String   @default("draft") // draft | saved

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([sessionId])
  @@index([type])
}
