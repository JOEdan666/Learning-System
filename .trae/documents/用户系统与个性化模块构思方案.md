# 用户体系与个性化学习模块构思

要实现“用户注册登录 + 数据持久化 + 个性化建议”，我们需要引入完整的用户身份认证系统（Auth）并重构现有的数据模型以支持多用户。以下是详细的构思方案：

## 1. 核心架构设计

### 1.1 身份认证 (Authentication)
*   **技术选型**：推荐使用 **Clerk** 或 **NextAuth.js (Auth.js)**。考虑到您希望快速集成且界面美观，**Clerk** 是非常好的选择，它提供了现成的登录/注册 UI 组件，且对 Next.js 支持极佳。
*   **流程**：
    1.  用户访问首页，点击“登录/注册”。
    2.  跳转到 Clerk 托管的登录页（支持邮箱、Google、GitHub 等）。
    3.  登录成功后，回调回应用，系统获得 `userId`。

### 1.2 数据库模型改造 (Schema Design)
我们需要在现有的 Prisma Schema 中引入 `User` 概念，并将所有数据（学习记录、错题本、笔记等）与 `User` 关联。

**新增/修改模型：**

*   **User (由 Clerk 管理，本地数据库可选同步)**
    *   虽然 Clerk 管理用户，但建议在本地库建一个 `UserProfile` 表，存储个性化设置。
    *   字段：`id` (对应 Clerk ID), `grade` (年级), `region` (地区), `preferences` (学习偏好 JSON)。

*   **关联现有表**：所有核心业务表都需要增加 `userId` 字段。
    *   `LearningSession` (学习会话) -> 增加 `userId`
    *   `WrongQuestion` (错题本) -> 增加 `userId`
    *   `Note` (笔记) -> 增加 `userId`
    *   `LearningStats` (学习统计) -> 增加 `userId`

### 1.3 业务流程闭环

1.  **初次注册引导 (Onboarding)**：
    *   用户注册后，首次登录进入“初始化设置页”。
    *   系统询问：年级（初二）、地区（江苏）、目标（中考提分）。
    *   保存至 `UserProfile`。

2.  **数据持久化**：
    *   用户的所有操作（创建对话、做题、记笔记）在写入数据库时，都带上当前登录用户的 `userId`。
    *   用户下次登录时，查询数据时只筛选 `where: { userId: currentUserId }`。

3.  **个性化推荐引擎**：
    *   **输入**：用户的 `UserProfile` (年级/地区) + `LearningStats` (历史薄弱点/错题)。
    *   **处理**：每次进入主页或学习模块时，AI 读取这些上下文。
    *   **输出**：
        *   “你上次在[物理-浮力]模块错误率较高，建议今天复习。”
        *   “根据[江苏]考纲，初二下学期重点是...”

## 2. 实施路线图

### 第一阶段：基础设施搭建
1.  **集成 Clerk**：安装 SDK，配置环境变量，包裹 `ClerkProvider`。
2.  **Schema 迁移**：修改 `schema.prisma`，为所有表添加 `userId` 字段（注意处理现有数据的迁移，可能需要清空旧数据或赋默认值）。
3.  **API 鉴权**：在所有 API Route (`app/api/...`) 中增加用户身份校验 `auth()`。

### 第二阶段：业务逻辑关联
1.  **主页改造**：根据登录状态显示不同内容（未登录显示 Landing Page，已登录显示 Dashboard）。
2.  **数据隔离**：修改 `prisma.findMany` 查询，确保用户只能看到自己的数据。

### 第三阶段：个性化增强
1.  **用户画像**：完善 `UserProfile` 表。
2.  **智能推荐**：编写一个新的 Service，专门用于分析用户历史数据并生成 Prompt 发给 AI，获取建议。

## 3. 推荐的 Prisma Schema 变更示例

```prisma
// 新增用户配置表
model UserProfile {
  id        String   @id // 直接使用 Clerk 的 User ID
  email     String   @unique
  name      String?
  grade     String?  // e.g. "Grade 8"
  region    String?  // e.g. "Jiangsu"
  goals     String[] // e.g. ["Improve Math", "Prepare for Zhongkao"]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 修改现有表，添加 userId
model LearningSession {
  // ... 原有字段
  userId    String   // 关联字段
  
  @@index([userId]) // 添加索引提高查询效率
}
```

如果您同意这个构思，我们可以从**集成 Clerk**和**修改数据库结构**开始第一步。
