(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{9713:function(e,t,r){Promise.resolve().then(r.bind(r,4711))},4711:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return N}});var a=r(7437),s=r(2265),n=r(6434).Buffer;class l{onMessage(e){this.messageHandler=e}onError(e){this.errorHandler=e}async sendMessage(e,t){var r,a,s,n,l,o,i;try{let i=await fetch("/api/openai-chat?stream=1",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e,history:t})});if(!i.ok){let e=i.status,t=null,r="";try{t=await i.json()}catch(e){r=await i.text().catch(()=>"")}let a=(null==t?void 0:t.error)||r||"请求失败: ".concat(e),n=a;switch(e){case 401:n="鉴权失败（401）。请检查 OPENAI_API_KEY 是否正确且具备相应权限。详情：".concat(a);break;case 402:n="余额不足（402）。请为当前账户充值，或切换到讯飞提供商（设置 NEXT_PUBLIC_AI_PROVIDER=xunfei 并重启）。详情：".concat(a);break;case 403:n="无权限（403）。请确认账号已开通对应模型与接口权限。详情：".concat(a);break;case 404:n="未找到接口或模型（404）。请核对 OPENAI_BASE_URL 与 OPENAI_MODEL。详情：".concat(a);break;case 429:n="超出速率/配额限制（429）。请稍后重试或提升配额。详情：".concat(a);break;default:e>=500&&(n="上游服务异常（".concat(e,"）。请稍后再试。详情：").concat(a))}null===(s=this.errorHandler)||void 0===s||s.call(this,n);return}if((i.headers.get("content-type")||"").includes("application/json")){let e=await i.json(),t=(null==e?void 0:e.content)||"";null===(n=this.messageHandler)||void 0===n||n.call(this,t,!0);return}let c=null===(r=i.body)||void 0===r?void 0:r.getReader(),d=new TextDecoder("utf-8");if(!c){null===(l=this.errorHandler)||void 0===l||l.call(this,"浏览器不支持流式读取响应");return}let g=!1;for(;!g;){let{value:e,done:t}=await c.read();if(g=t,e){let t=d.decode(e,{stream:!0});t&&(null===(o=this.messageHandler)||void 0===o||o.call(this,t,!1))}}null===(a=this.messageHandler)||void 0===a||a.call(this,"",!0)}catch(e){null===(i=this.errorHandler)||void 0===i||i.call(this,(null==e?void 0:e.message)||"网络错误")}}close(){}constructor(){this.messageHandler=null,this.errorHandler=null}}var o=r(9064);let i="ai_conversations_v1",c="ai_conversations_active_id_v1";var d=e=>{var t;let{savedItems:r,onClose:n}=e,[d,g]=(0,s.useState)([]),[u,m]=(0,s.useState)(""),[h,x]=(0,s.useState)(!1),[p,f]=(0,s.useState)(null),[b,y]=(0,s.useState)(!1),[w,v]=(0,s.useState)([]),[j,k]=(0,s.useState)(null),[S,N]=(0,s.useState)(null),[C,D]=(0,s.useState)(""),I=(0,s.useRef)(null),E=(0,s.useRef)(null),P=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];console.log("[AI聊天组件]",...t)};(0,s.useEffect)(()=>{let e=new l;if(e){var t,r;P("初始化AI Provider"),E.current=e,null===(r=E.current)||void 0===r||null===(t=r.setDebugMode)||void 0===t||t.call(r,!0),E.current.onMessage((e,t)=>{g(t=>{let r=t[t.length-1];return r&&"assistant"===r.role?[...t.slice(0,-1),{...r,content:r.content+e}]:[...t,{role:"assistant",content:e}]}),t&&x(!1)}),E.current.onError(e=>{f(e),x(!1)})}else f("未检测到可用的AI Provider，请检查环境变量配置");return()=>{E.current&&E.current.close()}},[]),(0,s.useEffect)(()=>{try{let e=localStorage.getItem(i);if(e){let t;let r=JSON.parse(e);v(r);let a=localStorage.getItem(c);a&&(t=r.find(e=>e.id===a)),!t&&r.length>0&&(t=[...r].sort((e,t)=>t.updatedAt-e.updatedAt)[0]),t&&(k(t.id),g(t.messages||[]))}}catch(e){console.warn("载入会话失败:",e)}},[]),(0,s.useEffect)(()=>{j&&v(e=>{let t=e.findIndex(e=>e.id===j);if(-1===t)return e;let r={...e[t],messages:d,updatedAt:Date.now()},a=[...e];a[t]=r;try{localStorage.setItem(i,JSON.stringify(a)),localStorage.setItem(c,j)}catch(e){}return a})},[d,j]);let M=e=>{let t=e.find(e=>"user"===e.role);if(t){let e=t.content.trim().replace(/\s+/g," ");return e.length>20?e.slice(0,20)+"…":e||"新对话"}return"对话 ".concat(new Date().toLocaleString("zh-CN"))},A=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(j)return j;let t="".concat(Date.now(),"_").concat(Math.random().toString(36).slice(2,8)),r=Date.now(),a={id:t,title:M(e),messages:e,createdAt:r,updatedAt:r};return v(e=>{let r=[a,...e];try{localStorage.setItem(i,JSON.stringify(r))}catch(e){}try{localStorage.setItem(c,t)}catch(e){}return r}),k(t),t},L=e=>{let t=w.find(t=>t.id===e);k(e),g((null==t?void 0:t.messages)||[]);try{localStorage.setItem(c,e)}catch(e){}},_=e=>{N(e.id),D(e.title)},O=()=>{N(null),D("")},B=()=>{if(!S)return;let e=C.trim()||"未命名对话";v(t=>{let r=t.map(t=>t.id===S?{...t,title:e,updatedAt:Date.now()}:t);try{localStorage.setItem(i,JSON.stringify(r))}catch(e){}return r}),N(null)},R=e=>{v(t=>{let r=t.filter(t=>t.id!==e);try{localStorage.setItem(i,JSON.stringify(r))}catch(e){}if(e===j){let e=r.length>0?[...r].sort((e,t)=>t.updatedAt-e.updatedAt)[0].id:null;if(k(e),e){let t=r.find(t=>t.id===e);g((null==t?void 0:t.messages)||[]);try{localStorage.setItem(c,e)}catch(e){}}else{g([]);try{localStorage.removeItem(c)}catch(e){}}}return S===e&&(N(null),D("")),r})},z=e=>{"Enter"===e.key?(e.preventDefault(),B()):"Escape"===e.key&&(e.preventDefault(),O())};(0,s.useEffect)(()=>{I.current&&(I.current.scrollTop=I.current.scrollHeight)},[d]);let W=e=>{let t=(e||"").slice(0,500);if(!r||0===r.length)return"你是有帮助的学习助手。当前没有可用的外部资料，请基于通用知识回答；若无法确定请直说不足。";let a=e=>(e||"").replace(/\s+/g," ").trim(),s=e=>/[\u3400-\u9fff]/.test(e),n=e=>{let t=[];for(let r of e.toLowerCase())s(r)?t.push(r):/\w/.test(r)?t.push(r):t.push(" ");return t.join("").split(/[^\w\u3400-\u9fff]+/).filter(Boolean)},l=new Set(n(t)),o=e=>{if(0===l.size)return 0;let t=n(e);if(0===t.length)return 0;let r=0;for(let e of t)l.has(e)&&r++;return r/Math.sqrt(t.length)},i=[];for(let e of r){let t=a(e.text||"");if(t)for(let r of(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:600,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:80,s=a(e);if(s.length<=t)return[s];let n=[],l=0;for(;l<s.length;){let e=Math.min(s.length,l+t);if(n.push(s.slice(l,e)),e===s.length)break;l=Math.max(e-r,l+1)}return n})(t).slice(0,12)){let t=o(r);t>0&&i.push({score:t,text:r,source:e.subject||"外部资料"})}}if(0===i.length){let e=r.map(e=>"【来源：".concat(e.subject,"】\n").concat(a(e.text||""))).join("\n\n").slice(0,6e3);return"你是有帮助的学习助手。请尽量依据下述材料回答，若材料未覆盖请直说不足。\n\n材料：\n".concat(e)}let c=i.sort((e,t)=>t.score-e.score).slice(0,8).map((e,t)=>"【片段".concat(t+1,"｜来源：").concat(e.source,"】\n").concat(e.text));return"系统提示：\n".concat("你必须优先依据提供的片段作答；如片段未涵盖，请明确说明资料不足，并给出你能给的通用建议。\n保持答案简明、结构化；适当引用关键句并标注来源片段编号。","\n\n检索到的相关资料片段如下：\n").concat(c.join("\n\n"))},F=async()=>{if(!u.trim()||h||!E.current)return;f(null),x(!0),o.ZP.loading("AI正在思考中...",{id:"ai-thinking"});let e={role:"user",content:u.trim()},t=A([...d,e]);g(t=>[...t,e]),v(r=>r.map(r=>r.id===t?{...r,title:r.title||M([e])}:r));try{let e=W(u.trim()),t=[{role:"system",content:e},...d.filter(e=>"system"!==e.role)];g(e=>[...e,{role:"assistant",content:""}]),await E.current.sendMessage(u.trim(),t),o.ZP.success("回复完成",{id:"ai-thinking"})}catch(t){let e=t instanceof Error?t.message:String(t);f("发送消息失败: ".concat(e)),x(!1),o.ZP.error("发送消息失败: ".concat(e),{id:"ai-thinking"}),console.error("发送消息时发生错误:",t)}m("")},T=e=>e.split(/(\*\*[^*]+\*\*)/).map((e,t)=>e.startsWith("**")&&e.endsWith("**")?(0,a.jsx)("strong",{className:"font-bold text-blue-700",children:e.substring(2,e.length-2)},t):e),H=e=>e.replace(/^\s*#{1,6}\s*/gm,""),J=e=>{if(!e)return null;let t=H(e),r=t.split(/\n\n+/);return 1===r.length?t.split("\n").map((e,t)=>(0,a.jsx)("p",{className:"whitespace-pre-wrap",children:T(e)},t)):r.map((e,t)=>(0,a.jsx)("p",{className:"whitespace-pre-wrap mb-3",children:T(e)},t))};return(0,a.jsxs)("div",{className:"fixed inset-0 z-50 bg-black/70 flex backdrop-blur-sm",children:[(0,a.jsxs)("aside",{className:"w-64 md:w-72 border-r border-gray-200 dark:border-gray-700 flex flex-col bg-white dark:bg-gray-800",children:[(0,a.jsxs)("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-gray-50 dark:bg-gray-900",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-800 dark:text-white",children:"AI对话"}),(0,a.jsx)("button",{onClick:()=>{let e="".concat(Date.now(),"_").concat(Math.random().toString(36).slice(2,8)),t=Date.now(),r={id:e,title:"对话 ".concat(new Date().toLocaleString("zh-CN")),messages:[],createdAt:t,updatedAt:t};v(e=>{let t=[r,...e];try{localStorage.setItem(i,JSON.stringify(t))}catch(e){}return t}),k(e);try{localStorage.setItem(c,e)}catch(e){}g([]),m("")},className:"text-blue-600 dark:text-blue-400 text-sm hover:underline",children:"新建"})]}),(0,a.jsx)("div",{className:"p-3 overflow-y-auto flex-1",children:0===w.length?(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"暂无历史对话"}):(0,a.jsx)("ul",{className:"space-y-2",children:w.map(e=>(0,a.jsxs)("li",{className:"group",children:[S===e.id?(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("input",{autoFocus:!0,value:C,onChange:e=>D(e.target.value),onKeyDown:z,onBlur:B,className:"w-full text-sm border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"输入对话标题"}),(0,a.jsx)("button",{type:"button",onMouseDown:e=>e.preventDefault(),onClick:B,className:"text-xs px-2 py-1 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors","aria-label":"保存重命名",children:"保存"}),(0,a.jsx)("button",{type:"button",onMouseDown:e=>e.preventDefault(),onClick:O,className:"text-xs px-2 py-1 rounded border dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors","aria-label":"取消重命名",children:"取消"})]}):(0,a.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,a.jsx)("button",{className:"flex-1 text-left text-sm truncate ".concat(e.id===j?"text-blue-700 dark:text-blue-400 underline":"text-blue-600 dark:text-blue-400 hover:underline"),onClick:()=>L(e.id),title:e.title,children:e.title}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{type:"button",onClick:()=>_(e),className:"opacity-70 group-hover:opacity-100 text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 underline","aria-label":"重命名会话",title:"重命名",children:"重命名"}),(0,a.jsx)("button",{type:"button",onClick:()=>R(e.id),className:"opacity-70 group-hover:opacity-100 text-xs text-red-500 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 underline","aria-label":"删除会话",title:"删除",children:"删除"})]})]}),(0,a.jsx)("div",{className:"text-xs text-gray-400 dark:text-gray-500",children:new Date(e.updatedAt).toLocaleString("zh-CN")})]},e.id))})}),(0,a.jsx)("div",{className:"p-3 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-900",children:(0,a.jsx)("button",{onClick:n,className:"w-full text-sm py-1.5 border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors",children:"关闭"})})]}),(0,a.jsxs)("main",{className:"flex-1 flex flex-col bg-white dark:bg-gray-800",children:[(0,a.jsxs)("div",{className:"px-4 py-3 border-b dark:border-gray-700 flex items-center justify-between bg-gray-50 dark:bg-gray-900",children:[(0,a.jsx)("div",{className:"font-medium text-gray-700 dark:text-gray-200 truncate",children:(null===(t=w.find(e=>e.id===j))||void 0===t?void 0:t.title)||"新对话"}),(0,a.jsx)("div",{className:"text-xs text-gray-400 dark:text-gray-500",children:r.length>0?"已保存学习内容 ".concat(r.length," 项"):"无已保存内容"})]}),p&&(0,a.jsx)("div",{className:"bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-400 px-4 py-3 border-b dark:border-red-800/30",children:p}),(0,a.jsx)("div",{ref:I,className:"flex-1 p-4 overflow-y-auto bg-gray-50 dark:bg-gray-900",children:(0,a.jsxs)("div",{className:"max-w-3xl mx-auto space-y-2",children:[d.map((e,t)=>{if("system"===e.role)return null;let r="user"===e.role;return(0,a.jsx)("div",{className:"flex ".concat(r?"justify-end":"justify-start"," mb-4"),children:(0,a.jsx)("div",{className:"max-w-[80%] p-3 rounded-lg \n            ".concat(r?"bg-blue-500 text-white":"bg-gray-100 text-gray-800","\n          "),children:J(e.content)})},t)}),h&&(0,a.jsx)("div",{className:"flex justify-start mb-4",children:(0,a.jsx)("div",{className:"max-w-[80%] p-3 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 border dark:border-gray-700 shadow-sm",children:(0,a.jsx)("p",{className:"animate-pulse",children:"AI正在思考..."})})})]})}),(0,a.jsxs)("div",{className:"border-t dark:border-gray-700 px-4 py-2 bg-white dark:bg-gray-800",children:[(0,a.jsxs)("button",{onClick:()=>y(!b),className:"text-sm text-gray-600 dark:text-gray-300 hover:underline",children:[b?"隐藏":"显示","已保存的学习内容 (",r.length,"项)"]}),b&&(0,a.jsx)("div",{className:"mt-2",children:0===r.length?(0,a.jsx)("p",{className:"text-gray-500 text-sm",children:"暂无已保存的学习内容"}):(0,a.jsx)("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:r.slice(-5).reverse().map(e=>(0,a.jsxs)("div",{className:"p-2 bg-gray-50 rounded text-sm",children:[(0,a.jsx)("div",{className:"font-medium text-blue-600",children:e.subject}),(0,a.jsx)("div",{className:"text-gray-700 truncate",children:e.text}),(0,a.jsx)("div",{className:"text-xs text-gray-400",children:new Date(e.createdAt).toLocaleTimeString("zh-CN")})]},e.id))})})]}),(0,a.jsx)("div",{className:"p-4 border-t dark:border-gray-700 bg-white dark:bg-gray-800",children:(0,a.jsxs)("div",{className:"max-w-3xl mx-auto",children:[(0,a.jsx)("textarea",{value:u,onChange:e=>m(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),F())},placeholder:"输入您的问题，按Enter发送，Shift+Enter换行...",className:"w-full p-3 border dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 h-28 resize-none bg-gray-50 dark:bg-gray-700 dark:text-white",disabled:h}),(0,a.jsx)("div",{className:"flex justify-end mt-2",children:(0,a.jsx)("button",{onClick:F,disabled:!u.trim()||h,className:"px-4 py-2 rounded-md text-white transition-colors ".concat(u.trim()&&!h?"bg-blue-600 hover:bg-blue-700":"bg-gray-300 dark:bg-gray-600 cursor-not-allowed"),children:h?"发送中...":"发送"})})]})})]})]})},g=e=>{let{dataUrl:t,name:n,onClose:l,onExtract:i}=e,c=(0,s.useRef)(null),[d,g]=(0,s.useState)(null),[u,m]=(0,s.useState)(null),[h,x]=(0,s.useState)(1),[p,f]=(0,s.useState)(1),[b,y]=(0,s.useState)(1.2),[w,v]=(0,s.useState)(!0),[j,k]=(0,s.useState)(null),[S,N]=(0,s.useState)(!1),[C,D]=(0,s.useState)(0),[I,E]=(0,s.useState)(0);(0,s.useEffect)(()=>{let e=!1,r=async()=>{try{let e;if(v(!0),D(10),window.pdfjsLib)return D(50),window.pdfjsLib;if(await (e="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js",new Promise((t,r)=>{let a=document.createElement("script");a.src=e,a.onload=()=>t(),a.onerror=()=>r(Error("加载脚本失败: ".concat(e))),document.head.appendChild(a)})),D(40),!window.pdfjsLib)throw Error("PDF.js库未正确加载");return window.pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js",D(50),window.pdfjsLib}catch(e){throw console.error("加载PDF.js失败:",e),e}};return(async()=>{try{let a=await r();if(e)return;g(a);let s=a.getDocument({url:t});s.onProgress=e=>{if(e.total){let t=Math.min(90,50+Math.round(e.loaded/e.total*40));D(t)}};let n=await s.promise;if(e)return;m(n),f(n.numPages||1),x(1),D(100)}catch(t){let e=(null==t?void 0:t.message)||"PDF 加载失败";console.error("PDF加载错误:",t),k(e),o.ZP.error(e)}finally{v(!1)}})(),()=>{e=!0}},[t]);let P=(0,s.useCallback)(async e=>{if(u&&c.current)try{let t=await u.getPage(e),r=t.getViewport({scale:b}),a=c.current,s=a.getContext("2d");if(!s)return;let n=window.devicePixelRatio||1;a.width=Math.floor(r.width*n),a.height=Math.floor(r.height*n),a.style.width=Math.floor(r.width)+"px",a.style.height=Math.floor(r.height)+"px",await t.render({canvasContext:s,viewport:r,transform:1!==n?[n,0,0,n,0,0]:void 0}).promise}catch(e){console.warn("渲染页面失败",e),o.ZP.error("页面渲染失败，请尝试重新加载")}},[u,b]);(0,s.useEffect)(()=>{u&&P(h)},[h,P,u]);let M=()=>x(e=>Math.max(1,e-1)),A=()=>x(e=>Math.min(p,e+1)),L=()=>y(e=>Math.min(3,e+.2)),_=()=>y(e=>Math.max(.5,e-.2));(0,s.useEffect)(()=>{let e=e=>{"ArrowLeft"===e.key?M():"ArrowRight"===e.key?A():"+"===e.key||"="===e.key?L():"-"===e.key?_():"Escape"===e.key&&l()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[p]);let O=async()=>{if(u)try{E(0),o.ZP.loading("正在提取文本...",{id:"extract-text"});let e="";for(let t=1;t<=u.numPages;t++)try{let r=await u.getPage(t),a=(await r.getTextContent()).items.map(e=>e.str||"").join(" ");e+=(t>1?"\n\n":"")+a,E(Math.round(t/u.numPages*100))}catch(e){console.error("提取第".concat(t,"页文本失败:"),e);continue}0===e.trim().length?o.ZP.error("未能提取到文本，请尝试OCR",{id:"extract-text"}):i&&"function"==typeof i?(i(e),o.ZP.success("文本提取成功",{id:"extract-text"})):o.ZP.error("回调函数无效，无法保存提取的文本",{id:"extract-text"})}catch(e){console.error("提取文本失败:",e),o.ZP.error("提取文本失败",{id:"extract-text"}),k("提取文本失败")}finally{E(0)}},B=async()=>{if(u)try{N(!0),o.ZP.loading("OCR处理中，这可能需要一些时间...",{id:"ocr-process"});let e=await r.e(525).then(r.t.bind(r,5525,23)),t=Math.min(u.numPages,10),a="";for(let r=1;r<=t;r++){o.ZP.loading("OCR处理第 ".concat(r,"/").concat(t," 页..."),{id:"ocr-process"});let s=await u.getPage(r),n=s.getViewport({scale:2}),l=document.createElement("canvas"),i=l.getContext("2d");if(!i)continue;l.width=n.width,l.height=n.height,await s.render({canvasContext:i,viewport:n}).promise;let{data:c}=await e.recognize(l,"eng+chi_sim",{logger:e=>{"recognizing text"===e.status&&o.ZP.loading("OCR处理第 ".concat(r,"/").concat(t," 页: ").concat(Math.round(100*e.progress),"%"),{id:"ocr-process"})}}),d=String((null==c?void 0:c.text)||"").trim();d&&(a+=(r>1?"\n\n":"")+d)}0===a.trim().length?(o.ZP.error("OCR未识别到文本（可能是低清晰度或受限PDF）",{id:"ocr-process"}),k("OCR 未识别到文本（可能是低清晰度或受限PDF）")):(null==i||i(a),o.ZP.success("OCR处理完成",{id:"ocr-process"}))}catch(t){let e=(null==t?void 0:t.message)||"OCR 失败";o.ZP.error(e,{id:"ocr-process"}),k(e)}finally{N(!1)}};return(0,a.jsx)("div",{className:"fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4 backdrop-blur-sm",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-gray-800 w-full max-w-5xl rounded-lg shadow-2xl overflow-hidden flex flex-col h-[90vh]",children:[(0,a.jsxs)("div",{className:"px-4 py-3 border-b dark:border-gray-700 flex items-center justify-between bg-gray-50 dark:bg-gray-900",children:[(0,a.jsx)("div",{className:"text-sm font-medium truncate dark:text-white",children:n||"PDF 预览"}),(0,a.jsxs)("div",{className:"flex items-center gap-2 flex-wrap justify-end",children:[(0,a.jsx)("button",{className:"px-2 py-1 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:border-gray-600 dark:text-gray-200",onClick:_,title:"缩小 (-)",children:"-"}),(0,a.jsxs)("span",{className:"text-xs text-gray-500 dark:text-gray-400 min-w-[40px] text-center",children:[Math.round(100*b),"%"]}),(0,a.jsx)("button",{className:"px-2 py-1 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:border-gray-600 dark:text-gray-200",onClick:L,title:"放大 (+)",children:"+"}),(0,a.jsx)("button",{className:"px-2 py-1 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:border-gray-600 dark:text-gray-200",onClick:M,disabled:h<=1,title:"上一页 (←)",children:"上一页"}),(0,a.jsxs)("span",{className:"text-xs text-gray-500 dark:text-gray-400 min-w-[50px] text-center",children:[h,"/",p]}),(0,a.jsx)("button",{className:"px-2 py-1 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:border-gray-600 dark:text-gray-200",onClick:A,disabled:h>=p,title:"下一页 (→)",children:"下一页"}),i&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{className:"px-2 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors",onClick:O,disabled:I>0,children:I>0?"提取中 ".concat(I,"%"):"提取文本用于AI"}),(0,a.jsx)("button",{className:"px-2 py-1 text-sm bg-orange-600 text-white rounded hover:bg-orange-700 transition-colors disabled:opacity-50",disabled:S,onClick:B,children:S?"OCR处理中…":"OCR提取（慢）"})]}),(0,a.jsx)("button",{className:"px-2 py-1 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:border-gray-600 dark:text-gray-200",onClick:l,title:"关闭 (ESC)",children:"关闭"})]})]}),(0,a.jsx)("div",{className:"flex-1 overflow-auto bg-gray-100 dark:bg-gray-900 grid place-items-center p-4",children:w?(0,a.jsxs)("div",{className:"flex flex-col items-center",children:[(0,a.jsx)("div",{className:"w-48 h-2 bg-gray-200 rounded-full overflow-hidden",children:(0,a.jsx)("div",{className:"h-full bg-blue-600 transition-all duration-300",style:{width:"".concat(C,"%")}})}),(0,a.jsxs)("div",{className:"text-gray-500 dark:text-gray-400 text-sm mt-2",children:["加载中... ",C,"%"]})]}):j?(0,a.jsxs)("div",{className:"text-red-600 text-sm p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800",children:[(0,a.jsx)("div",{className:"font-medium mb-1",children:"加载错误"}),j]}):(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("canvas",{ref:c,className:"shadow-lg border bg-white rounded"}),(0,a.jsxs)("div",{className:"absolute bottom-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded",children:["第 ",h," / ",p," 页"]})]})})]})})};let u="kb_items_v2",m="kb_items_backup_v2",h="kb_items";function x(e){if(0===e)return"0 B";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB"][t]}async function p(e){return new Promise((t,r)=>{let a=new FileReader;a.onload=()=>t(String(a.result||"")),a.onerror=r,a.readAsText(e)})}async function f(e){return new Promise((t,r)=>{let a=new FileReader;a.onload=()=>t(a.result),a.onerror=r,a.readAsArrayBuffer(e)})}async function b(e){return new Promise((t,r)=>{let a=new FileReader;a.onload=()=>t(String(a.result||"")),a.onerror=r,a.readAsDataURL(e)})}let y=()=>new Promise((e,t)=>{let r=indexedDB.open("knowledge_base_db",1);r.onerror=e=>{console.error("IndexedDB打开失败:",e),t("无法打开数据库")},r.onsuccess=t=>{e(t.target.result)},r.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains(h)||(t.createObjectStore(h,{keyPath:"id"}),console.log("创建IndexedDB存储"))}}),w=async e=>{try{let t=await y(),r=t.transaction([h],"readwrite"),a=r.objectStore(h);for(let t of(a.clear(),e))a.add(t);return new Promise(e=>{r.oncomplete=()=>{t.close(),e(!0)},r.onerror=r=>{console.error("保存到IndexedDB失败:",r),t.close(),e(!1)}})}catch(e){return console.error("IndexedDB操作失败:",e),!1}},v=async()=>{try{let e=await y(),t=e.transaction([h],"readonly").objectStore(h).getAll();return new Promise(r=>{t.onsuccess=()=>{e.close(),r(t.result||[])},t.onerror=t=>{console.error("从IndexedDB加载失败:",t),e.close(),r([])}})}catch(e){return console.error("IndexedDB操作失败:",e),[]}};async function j(e){let t=(e.type||"").toLowerCase(),a=e.name.toLowerCase();if(t.startsWith("text/")||a.endsWith(".txt")||a.endsWith(".md")||a.endsWith(".csv")||a.endsWith(".json"))try{return{text:await p(e)}}catch(e){return{note:"读取文本失败"}}if("application/pdf"===t||a.endsWith(".pdf"))try{let t=await r.e(980).then(r.bind(r,7781)),a=await f(e);try{t.GlobalWorkerOptions.workerSrc="//cdnjs.cloudflare.com/ajax/libs/pdf.js/".concat(t.version,"/pdf.worker.min.js")}catch(e){}let s=await t.getDocument({data:a}).promise,n="";for(let e=1;e<=s.numPages;e++){let t=await s.getPage(e),r=(await t.getTextContent()).items.map(e=>e.str||"").join(" ");n+=(e>1?"\n\n":"")+r}if((n||"").replace(/\s+/g," ").trim().length<50)try{let e=await r.e(525).then(r.t.bind(r,5525,23)),t=Math.min(s.numPages,8),a="";for(let r=1;r<=t;r++){let t=await s.getPage(r),n=t.getViewport({scale:2}),l=document.createElement("canvas"),o=l.getContext("2d");if(!o)continue;l.width=n.width,l.height=n.height,await t.render({canvasContext:o,viewport:n}).promise;let{data:i}=await e.recognize(l,"eng+chi_sim"),c=String((null==i?void 0:i.text)||"").trim();c&&(a+=(r>1?"\n\n":"")+c)}if(a.trim().length>0)return{text:a,note:"通过OCR提取了前".concat(t,"页文本")}}catch(e){}return{text:n}}catch(e){return{note:"PDF 解析未启用（缺少依赖或运行环境限制）"}}if(a.endsWith(".docx"))try{let t=await r.e(216).then(r.t.bind(r,5481,23)),a=await f(e),s=await t.convertToHtml({arrayBuffer:a}),n=document.createElement("div");return n.innerHTML=s.value,{text:n.textContent||n.innerText||""}}catch(e){return{note:"DOCX 解析未启用（缺少依赖）"}}if(a.endsWith(".xlsx")||a.endsWith(".xls"))try{let t=await Promise.all([r.e(425),r.e(919)]).then(r.bind(r,2093)),a=await f(e),s=t.read(a,{type:"array"}),n=s.SheetNames,l=[];for(let e of n){let r=s.Sheets[e],a=t.utils.sheet_to_csv(r);l.push("# ".concat(e,"\n").concat(a))}return{text:l.join("\n\n")}}catch(e){return{note:"Excel 解析未启用（缺少依赖）"}}if(t.startsWith("image/")||a.endsWith(".png")||a.endsWith(".jpg")||a.endsWith(".jpeg"))try{let t=await r.e(525).then(r.t.bind(r,5525,23)),a=URL.createObjectURL(e),{data:s}=await t.recognize(a,"eng+chi_sim");return URL.revokeObjectURL(a),{text:(null==s?void 0:s.text)||"",note:"OCR 自动提取"}}catch(e){return{note:"OCR 未启用（缺少依赖）"}}return t.startsWith("video/")||a.endsWith(".mov")||a.endsWith(".mp4")?{note:"视频暂不自动转写音频，可添加手动摘要"}:{note:"暂不支持的文件类型，已保存元数据"}}var k=e=>{let{onItemsChange:t}=e,[n,l]=(0,s.useState)([]),[i,c]=(0,s.useState)(!1),d=(0,s.useRef)(null),[h,p]=(0,s.useState)(null),[f,y]=(0,s.useState)(!1),[k,S]=(0,s.useState)(!0),[N,C]=(0,s.useState)("memory"),D=(0,s.useCallback)(()=>{try{if("indexedDB"in window)return"indexeddb"}catch(e){console.warn("IndexedDB不可用:",e)}try{let e="__storage_test_".concat(Date.now());localStorage.setItem(e,e);let t=localStorage.getItem(e);if(localStorage.removeItem(e),t===e)return"localstorage"}catch(e){console.warn("localStorage不可用:",e)}try{let e="__storage_test_".concat(Date.now());sessionStorage.setItem(e,e);let t=sessionStorage.getItem(e);if(sessionStorage.removeItem(e),t===e)return"sessionstorage"}catch(e){console.warn("sessionStorage不可用:",e)}return"memory"},[]);(0,s.useEffect)(()=>{(async()=>{y(!0);try{let e=D();C(e),S("memory"!==e),console.log("使用存储类型:",e);let r=[];if("indexeddb"===e&&(r=await v(),console.log("从IndexedDB加载了",r.length,"个项目")),0===r.length&&("indexeddb"===e||"localstorage"===e))try{let t=localStorage.getItem(u);if(t){let a=JSON.parse(t);Array.isArray(a)&&(r=a,console.log("从localStorage加载了",r.length,"个项目"),"indexeddb"===e&&w(r).then(e=>{e&&console.log("已同步项目到IndexedDB")}))}}catch(e){console.error("从localStorage加载失败:",e)}if(0===r.length)try{let e=sessionStorage.getItem(m);if(e){let t=JSON.parse(e);Array.isArray(t)&&(r=t,console.log("从sessionStorage加载了",r.length,"个项目"))}}catch(e){console.error("从sessionStorage加载失败:",e)}r.length>0&&(l(r),t&&t(r),o.Am.success("已加载".concat(r.length,"个知识库项目")))}catch(e){console.error("加载知识库项目失败:",e),o.Am.error("加载知识库失败，请刷新重试"),S(!1)}finally{y(!1)}})()},[D,t]),(0,s.useEffect)(()=>{let e=async()=>{if("indexeddb"===N&&await w(n)){console.log("成功保存到IndexedDB");try{localStorage.setItem(u,JSON.stringify(n)),sessionStorage.setItem(m,JSON.stringify(n))}catch(e){console.warn("备份到localStorage/sessionStorage失败，但IndexedDB已保存成功",e)}return}let e=e=>localStorage.setItem(u,JSON.stringify(e)),t=e=>sessionStorage.setItem(m,JSON.stringify(e));try{try{e(n);try{t(n)}catch(e){}}catch(a){let r=n.map(e=>{if((null==e?void 0:e.dataUrl)&&e.dataUrl.length>2e5){let{dataUrl:t,...r}=e;return r}return e});try{e(r);try{t(r)}catch(e){}console.warn("[KB] 已压缩保存：为避免超过 localStorage 限制，移除了部分大文件预览。")}catch(a){let r=n.map(e=>{let{dataUrl:t,...r}=e;return r});try{e(r);try{t(r)}catch(e){}console.warn("[KB] 已极限压缩保存：移除了全部预览以确保持久化。")}catch(e){console.error("[KB] 保存失败：localStorage 容量或权限问题。",e);try{t(n)}catch(e){}}}}}catch(e){}};n.length>0&&e(),null==t||t(n)},[n,t,N]);let I=(0,s.useCallback)(async e=>{if(!e||0===e.length)return;y(!0);let t=[];for(let a of Array.from(e)){let e;let s="".concat(Date.now(),"_").concat(Math.random().toString(36).slice(2,8)),n={id:s,name:a.name,type:a.type,size:a.size,lastModified:a.lastModified,createdAt:Date.now(),include:!0},i=a.name.toLowerCase();if(("application/pdf"===a.type||i.endsWith(".pdf"))&&a.size<=2097152){try{e=await b(a),o.Am.loading('正在自动处理PDF文件"'.concat(a.name,'"...'),{id:"pdf-ocr-".concat(s),duration:1e4});let i={...n,text:"[PDF文件: ".concat(a.name,"]\n\n正在自动提取文本，请稍候...\n\n文件大小: ").concat(x(a.size),"\n上传时间: ").concat(new Date().toLocaleString()),notes:"",dataUrl:e};t.push(i),setTimeout(async()=>{try{let t=await (async()=>{if(window.pdfjsLib)return window.pdfjsLib;let e=e=>new Promise((t,r)=>{let a=document.createElement("script");a.src=e,a.onload=()=>t(),a.onerror=()=>r(Error("加载脚本失败: ".concat(e))),document.head.appendChild(a)});if(await e("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"),!window.pdfjsLib)throw Error("PDF.js库未正确加载");return window.pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js",window.pdfjsLib})();if(!t)throw Error("无法加载PDF.js");let n=t.getDocument({url:e}),i=await n.promise,c="";for(let e=1;e<=Math.min(i.numPages,10);e++)try{let t=await i.getPage(e),r=(await t.getTextContent()).items.map(e=>e.str||"").join(" ");c+=(e>1?"\n\n":"")+r}catch(t){console.error("提取第".concat(e,"页文本失败:"),t)}if(c.trim().length<100){o.Am.loading("PDF文本较少，正在尝试OCR识别...",{id:"pdf-ocr-".concat(s),duration:2e4});let e=await r.e(525).then(r.t.bind(r,5525,23)),t=document.createElement("canvas"),a=t.getContext("2d");if(!a)throw Error("无法创建Canvas上下文");let n="";for(let r=1;r<=Math.min(i.numPages,3);r++){let s=await i.getPage(r),l=s.getViewport({scale:2});t.width=l.width,t.height=l.height,await s.render({canvasContext:a,viewport:l}).promise;let{data:o}=await e.recognize(t,"eng+chi_sim"),c=String((null==o?void 0:o.text)||"").trim();c&&(n+=(r>1?"\n\n":"")+c)}n.trim().length>0&&(c=n)}c.trim().length>0?(l(e=>e.map(e=>e.id===s?{...e,text:c}:e)),o.Am.success('PDF文件"'.concat(a.name,'"文本提取成功'),{id:"pdf-ocr-".concat(s)})):o.Am.error("无法从PDF提取文本，请手动处理",{id:"pdf-ocr-".concat(s)})}catch(e){console.error("自动OCR处理失败:",e),o.Am.error("自动处理PDF失败，请手动提取文本",{id:"pdf-ocr-".concat(s)})}},500)}catch(l){console.error("PDF处理失败:",l);let r="[PDF文件: ".concat(a.name,"]\n\n此PDF已上传到知识库，但自动提取失败。请手动提取文本。\n\n文件大小: ").concat(x(a.size),"\n上传时间: ").concat(new Date().toLocaleString()),{note:s}=await j(a);t.push({...n,text:r,notes:s,dataUrl:e})}continue}let{text:c,note:d}=await j(a);t.push({...n,text:c,notes:d,dataUrl:e})}l(e=>[...t,...e]),y(!1)},[]),E=e=>l(t=>t.filter(t=>t.id!==e)),P=async e=>{let t=document.createElement("input");t.type="file",t.accept="",t.onchange=async()=>{var r;let a=null===(r=t.files)||void 0===r?void 0:r[0];if(!a)return;let{text:s,note:n}=await j(a);l(t=>t.map(t=>t.id===e.id?{...t,text:s,notes:n}:t))},t.click()};return(0,a.jsxs)("section",{className:"bg-white/70 border border-blue-200 rounded-lg p-4 shadow-sm",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,a.jsx)("h2",{className:"text-base font-semibold text-blue-700",children:"知识库（上传文件以加入上下文）"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{className:"px-3 py-1.5 text-sm rounded border hover:bg-gray-50",onClick:()=>{var e;return null===(e=d.current)||void 0===e?void 0:e.click()},children:"选择文件"}),(0,a.jsx)("input",{ref:d,type:"file",multiple:!0,className:"hidden",onChange:e=>I(e.target.files)})]})]}),(0,a.jsx)("div",{onDrop:e=>{e.preventDefault(),c(!1),I(e.dataTransfer.files)},onDragOver:e=>{e.preventDefault(),c(!0)},onDragLeave:e=>{e.preventDefault(),c(!1)},className:"border-2 border-dashed rounded-md p-6 text-center transition-colors ".concat(i?"border-blue-500 bg-blue-50":"border-gray-300 bg-gray-50"),children:"拖拽文件到此处，或点击“选择文件”上传。支持 PDF、Word、TXT、Excel、PNG、JPG、MOV 等。"}),(0,a.jsx)("div",{className:"mt-4",children:0===n.length?(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"尚未上传文件。"}):(0,a.jsx)("ul",{className:"space-y-3 max-h-72 overflow-y-auto",children:n.map(e=>(0,a.jsxs)("li",{className:"border rounded-md p-3 bg-white",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("div",{className:"font-medium text-gray-800 truncate",title:e.name,children:e.name}),(0,a.jsxs)("div",{className:"text-xs text-gray-500",children:[e.type||"未知类型"," \xb7 ",x(e.size)]})]}),(0,a.jsxs)("div",{className:"mt-2 flex items-center justify-between text-xs",children:[(0,a.jsxs)("label",{className:"inline-flex items-center gap-1 text-gray-600",children:[(0,a.jsx)("input",{type:"checkbox",checked:!1!==e.include,onChange:t=>l(r=>r.map(r=>r.id===e.id?{...r,include:t.target.checked}:r))}),"用于AI对话"]}),e.dataUrl&&("application/pdf"===e.type||e.name.toLowerCase().endsWith(".pdf"))&&(0,a.jsx)("button",{className:"underline text-blue-600",onClick:()=>p(e),children:"预览 PDF"})]}),e.text?(0,a.jsxs)("div",{className:"mt-2 text-sm text-gray-700 whitespace-pre-wrap max-h-24 overflow-y-auto",children:[e.text.slice(0,1e3),e.text.length>1e3?"…":""]}):(0,a.jsxs)("div",{className:"mt-2 text-sm text-gray-500 flex items-center gap-2",children:[(0,a.jsx)("span",{children:e.notes||"尚未解析内容"}),(0,a.jsx)("button",{className:"text-blue-600 underline text-xs",onClick:()=>P(e),children:"尝试解析"})]}),(0,a.jsxs)("div",{className:"mt-2 flex items-center justify-between text-xs text-gray-400",children:[(0,a.jsxs)("span",{children:["更新时间：",new Date(e.createdAt).toLocaleString("zh-CN")]}),(0,a.jsx)("button",{className:"underline hover:text-red-600",onClick:()=>E(e.id),children:"删除"})]})]},e.id))})}),h&&h.dataUrl&&(0,a.jsx)(g,{dataUrl:h.dataUrl,name:h.name,onClose:()=>p(null),onExtract:e=>{l(t=>t.map(t=>t.id===h.id?{...t,text:e}:t)),p(null)}})]})};let S=["语文","数学","英语","物理","政治","历史","生物","地理","化学","其他"];function N(){let[e,t]=(0,s.useState)(""),[r,n]=(0,s.useState)(S[0]),[l,o]=(0,s.useState)([]),[i,c]=(0,s.useState)(!1),[g,u]=(0,s.useState)(!0),[m,h]=(0,s.useState)([]),x=(0,s.useRef)(null),p=(0,s.useRef)(null),[f,b]=(0,s.useState)(""),[y,w]=(0,s.useState)(()=>window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches),[v,j]=(0,s.useState)(!1);(0,s.useEffect)(()=>{let e=()=>{j(window.innerWidth<768)};e(),window.addEventListener("resize",e);let t=window.matchMedia("(prefers-color-scheme: dark)"),r=e=>{w(e.matches)};return t.addEventListener("change",r),()=>{window.removeEventListener("resize",e),t.removeEventListener("change",r)}},[]);let N="learning_system_items",C="learning_system_version",D="2.0.0",I=N+"_backup",E=(0,s.useCallback)(()=>{try{let e="__storage_test_".concat(Date.now());localStorage.setItem(e,e);let t=localStorage.getItem(e);localStorage.removeItem(e);let r=t===e;return u(r),r||console.warn("localStorage检测失败，值不匹配"),r}catch(e){return console.warn("localStorage不可用:",e instanceof Error?e.message:String(e)),u(!1),!1}},[]),P=(0,s.useCallback)(()=>{try{if(g){let e=localStorage.getItem(N),t=localStorage.getItem(I),r=localStorage.getItem(C),a=Object.keys(localStorage);console.group("localStorage调试信息"),console.log("主数据键:",N),console.log("主数据内容:",e),console.log("备份数据键:",I),console.log("备份数据内容:",t),console.log("版本信息:",r),console.log("所有存储键:",a),console.log("存储项数量:",a.length),console.groupEnd()}}catch(e){console.error("调试localStorage失败:",e instanceof Error?e.message:String(e))}},[g]),M=(0,s.useCallback)(e=>{try{if(!Array.isArray(e))return console.error("数据不是数组格式:",typeof e),!1;if(!e.every(e=>"object"==typeof e&&null!==e&&"string"==typeof e.id&&"string"==typeof e.text&&"string"==typeof e.subject&&"string"==typeof e.createdAt))return console.error("数组中包含无效的学习项目"),!1;return e.length>500&&console.warn("存储项数量超过建议最大值"),!0}catch(e){return console.error("验证数据完整性失败:",e instanceof Error?e.message:String(e)),!1}},[]),A=(0,s.useCallback)(()=>{try{g&&(console.log("清理无效数据..."),localStorage.removeItem(N),localStorage.removeItem(C),console.log("无效数据已清理"))}catch(e){console.error("清理无效数据失败:",e instanceof Error?e.message:String(e))}},[g]);(0,s.useCallback)(e=>{try{g?(localStorage.setItem(I,JSON.stringify(e)),console.log("数据已备份到localStorage")):(sessionStorage.setItem(I,JSON.stringify(e)),console.log("数据已备份到sessionStorage"))}catch(e){console.error("创建数据备份失败:",e instanceof Error?e.message:String(e))}},[g]);let L=(0,s.useCallback)(()=>{try{console.log("尝试从备份恢复数据...");let e=localStorage.getItem(I),t="localStorage";if(e||(e=sessionStorage.getItem(I),t="sessionStorage"),e){let r=JSON.parse(e);if(M(r))return console.log("成功从".concat(t,"恢复数据，共").concat(r.length,"项")),r}return console.log("没有找到有效的备份数据"),null}catch(e){return console.error("从备份恢复数据失败:",e instanceof Error?e.message:String(e)),null}},[M]);(0,s.useEffect)(()=>{(async()=>{console.log("开始初始化存储系统...");let e=E();if(await new Promise(e=>setTimeout(e,100)),e)try{let e=localStorage.getItem(C);console.log("当前存储版本: ".concat(e||"未知","，目标版本: ").concat(D));let t=localStorage.getItem(N);if(console.log("加载主数据:",t?"存在":"不存在"),t)try{let r=JSON.parse(t),a=[];if(Array.isArray(r)&&(r.length>0&&"string"==typeof r[0]?(console.log("检测到旧版本数据，正在进行迁移..."),a=r.map((e,t)=>({id:"migrated_".concat(Date.now(),"_").concat(t),text:e,subject:S[0],createdAt:new Date().toISOString()})),console.log("数据迁移完成，共转换",a.length,"项")):M(r)&&(a=r,console.log("主数据加载成功，共",r.length,"项"))),a.length>0)o(a),e!==D&&(localStorage.setItem(C,D),console.log("存储版本已更新"));else{console.warn("主数据无效，尝试从备份恢复...");let e=L();e&&o(e),A()}}catch(t){console.error("解析主数据失败:",t instanceof Error?t.message:String(t));let e=L();e&&o(e),A()}else{console.log("主数据不存在，尝试从备份恢复...");let e=L();e?o(e):console.log("没有找到可恢复的数据，使用空数组")}}catch(t){console.error("初始化存储系统失败:",t instanceof Error?t.message:String(t));let e=L();e&&o(e)}finally{P()}else{console.warn("localStorage不可用，使用内存存储");let e=L();e&&o(e)}})()},[E,M,L,A,P]),(0,s.useEffect)(()=>{let e=setTimeout(()=>{if(console.log("准备保存数据，当前项目数量:",l.length),0===l.length){console.log("没有数据需要保存");return}if(!M(l)){console.error("待保存数据无效，跳过保存");return}let e=l.slice(-500);try{let t=JSON.stringify(e),r=new Blob([t]).size;if(console.log("准备保存".concat(e.length,"项数据，大小约").concat((r/1024).toFixed(2),"KB")),g)try{localStorage.setItem(I,t),console.log("数据已保存到备份位置"),localStorage.removeItem(N),localStorage.setItem(N,t),localStorage.setItem(C,D),localStorage.getItem(N)===t?(console.log("数据已成功保存到localStorage并验证通过"),b(new Date().toLocaleTimeString()),P()):(console.warn("数据保存验证失败，可能存在存储问题"),localStorage.setItem(N,localStorage.getItem(I)||t))}catch(e){console.error("保存到localStorage失败:",e instanceof Error?e.message:String(e));try{sessionStorage.setItem(N,t),sessionStorage.setItem(C,D),console.log("已将数据保存到sessionStorage"),b(new Date().toLocaleTimeString())}catch(e){console.error("保存到sessionStorage也失败:",e instanceof Error?e.message:String(e)),console.warn("数据仅保存在内存中，刷新页面将丢失")}}else try{sessionStorage.setItem(N,t),console.log("已将数据保存到sessionStorage"),b(new Date().toLocaleTimeString())}catch(e){console.error("保存到sessionStorage失败:",e instanceof Error?e.message:String(e)),console.warn("数据仅保存在内存中，刷新页面将丢失")}}catch(e){console.error("数据保存过程中发生错误:",e instanceof Error?e.message:String(e))}},300);return()=>clearTimeout(e)},[l,g,M,P]);let _=()=>{e.trim()&&(c(!0),setTimeout(()=>{let a={id:"item_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),text:e.trim(),subject:r,createdAt:new Date().toISOString()};o(e=>[...e,a]),t(""),c(!1),x.current&&x.current.focus(),p.current&&(p.current.classList.add("save-success"),setTimeout(()=>{p.current&&p.current.classList.remove("save-success")},500))},500))},O=e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),_())},B=e=>{let t=l.filter((t,r)=>r!==e);o(t);try{if(g&&t.length>0){let e=JSON.stringify(t);localStorage.setItem(N,e),localStorage.setItem(I,e),console.log("删除项目后数据已立即保存到localStorage")}else 0===t.length&&(localStorage.removeItem(N),localStorage.removeItem(I),sessionStorage.removeItem(N),sessionStorage.removeItem(I),console.log("所有项目已删除，已清除所有存储中的数据"))}catch(e){console.error("删除项目后立即保存失败:",e instanceof Error?e.message:String(e))}},[R,z]=(0,s.useState)(!1),W=[...l,...(m||[]).filter(e=>(null==e?void 0:e.include)!==!1).filter(e=>(null==e?void 0:e.text)&&String(e.text).trim().length>0||(null==e?void 0:e.notes)&&String(e.notes).trim().length>0).map(e=>({id:"kb_".concat(e.id),text:e.text?String(e.text):"[".concat(e.name||"附件","] ").concat(String(e.notes||"")),subject:e.name?"知识库/".concat(e.name):"知识库",createdAt:new Date(e.createdAt||Date.now()).toISOString()}))];return(0,a.jsxs)("div",{ref:p,className:"min-h-screen p-4 sm:p-6 md:p-8 flex flex-col transition-all duration-500 relative bg-cover bg-center bg-no-repeat ".concat(y?"dark bg-gray-900":""),style:{backgroundImage:y?"none":"url('/uni.png')"},children:[(0,a.jsxs)("header",{className:"text-center mb-8 animate-fade-in relative",children:[(0,a.jsx)("div",{className:"absolute right-4 top-2 flex items-center space-x-2",children:(0,a.jsx)("button",{onClick:()=>w(!y),className:"p-2 rounded-full bg-white/20 backdrop-blur-md hover:bg-white/30 transition-all duration-300","aria-label":y?"切换到亮色模式":"切换到暗色模式",children:y?(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-yellow-300",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"})}):(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-blue-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"})})})}),(0,a.jsx)("h1",{className:"text-3xl sm:text-4xl md:text-5xl font-bold mb-2 animate-gradient bg-clip-text text-transparent ".concat(y?"bg-gradient-to-r from-purple-400 to-pink-400":"bg-gradient-to-r from-blue-500 to-cyan-400"," transition-all duration-500 hover:scale-105"),children:"自学系统"}),(0,a.jsx)("p",{className:"".concat(y?"text-gray-300":"text-blue-200"," text-lg font-medium tracking-wide transition-all duration-300 hover:text-blue-100"),children:"以自学为基础，以生产为导向"})]}),(0,a.jsxs)("div",{className:"flex-grow flex gap-4",children:[(0,a.jsx)("aside",{className:"hidden md:block w-64 shrink-0 order-0",children:(0,a.jsx)("div",{className:"sticky top-6",children:(0,a.jsxs)("div",{className:"bg-white/95 border border-blue-200 rounded-lg p-4 shadow-md hover:shadow-lg transition-all duration-300 backdrop-blur-md transform hover:-translate-y-0.5",children:[(0,a.jsxs)("h3",{className:"text-base font-semibold text-blue-600 mb-2 flex items-center gap-2",children:[(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-blue-500",viewBox:"0 0 20 20",fill:"currentColor",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})}),"不做第一做唯一 \xb7 2035去火星\uD83E\uDEF5"]}),(0,a.jsx)("p",{className:"text-gray-700 mb-3 text-sm leading-relaxed",children:"这是一个AI时代，更是学习者和生产者的时代\uD83D\uDE0E"}),(0,a.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,a.jsx)("span",{className:"px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-medium",children:"自学"}),(0,a.jsx)("span",{className:"px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs font-medium",children:"积累"}),(0,a.jsx)("span",{className:"px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full text-xs font-medium",children:"思考"})]})]})})}),(0,a.jsx)("main",{className:"flex-grow order-1 flex flex-col items-center",children:(0,a.jsxs)("div",{className:"w-full max-w-2xl mx-auto my-6",children:[(0,a.jsx)("div",{className:"mb-6",children:(0,a.jsx)(k,{onItemsChange:h})}),(0,a.jsx)("div",{className:"md:hidden mb-6",children:l.length>0&&(0,a.jsxs)("div",{className:"animate-fade-in bg-white/70 border border-purple-200 rounded-lg p-3 shadow-md hover:shadow-lg transition-all duration-300 backdrop-blur-md",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,a.jsxs)("h2",{className:"text-sm font-semibold text-purple-600 flex items-center gap-1",children:[(0,a.jsx)("span",{className:"inline-flex items-center justify-center w-4 h-4 rounded-full bg-purple-100 text-purple-600 text-xs font-medium",children:"\uD83D\uDCDD"}),"已保存的内容 (",l.length,")"]}),(0,a.jsx)("button",{onClick:()=>{o([]);try{g&&(localStorage.removeItem(N),localStorage.removeItem(I),sessionStorage.removeItem(N),sessionStorage.removeItem(I),console.log("所有项目已清空，已清除所有存储中的数据"))}catch(e){console.error("清空项目后立即保存失败:",e instanceof Error?e.message:String(e))}},className:"text-xs text-gray-500 hover:text-red-500 transition-colors","aria-label":"清空所有内容",children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]}),(0,a.jsx)("ul",{className:"space-y-2 max-h-[180px] overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-purple-200 dark:scrollbar-thumb-purple-700 scrollbar-track-transparent",children:l.map((e,t)=>(0,a.jsxs)("li",{className:"flex items-start p-2 rounded-md bg-purple-50 text-gray-700 hover:bg-purple-100/50 transition-all duration-200 group relative",children:[(0,a.jsx)("span",{className:"inline-flex items-center justify-center w-4 h-4 rounded-full bg-purple-100 text-purple-600 text-xs font-medium mt-0.5",children:t+1}),(0,a.jsxs)("div",{className:"flex-grow",children:[(0,a.jsx)("span",{className:"inline-block px-1.5 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-md mb-1",children:e.subject}),(0,a.jsx)("span",{className:"flex-grow whitespace-pre-wrap break-words text-xs group-hover:text-purple-600 transition-colors",children:e.text})]}),(0,a.jsx)("button",{onClick:()=>B(t),className:"absolute right-1 top-1.5 opacity-0 group-hover:opacity-100 transition-opacity","aria-label":"删除第".concat(t+1,"项"),children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3 text-gray-400 hover:text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},e.id))})]})}),(0,a.jsx)("div",{className:"hidden md:block",children:l.length>0&&(0,a.jsxs)("div",{className:"animate-fade-in bg-white/70 border border-purple-200 rounded-lg p-4 shadow-md hover:shadow-lg transition-all duration-300 backdrop-blur-md mb-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,a.jsxs)("h2",{className:"text-sm font-semibold text-purple-600 flex items-center gap-1",children:[(0,a.jsx)("span",{className:"inline-flex items-center justify-center w-5 h-5 rounded-full bg-purple-100 text-purple-600 text-xs font-medium",children:"\uD83D\uDCDD"}),"已保存的内容 (",l.length,")"]}),(0,a.jsx)("button",{onClick:()=>{o([]);try{g&&(localStorage.removeItem(N),localStorage.removeItem(I),sessionStorage.removeItem(N),sessionStorage.removeItem(I),console.log("所有项目已清空，已清除所有存储中的数据"))}catch(e){console.error("清空项目后立即保存失败:",e instanceof Error?e.message:String(e))}},className:"text-sm text-gray-500 hover:text-red-500 transition-colors","aria-label":"清空所有内容",children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]}),(0,a.jsx)("ul",{className:"space-y-3 max-h-[300px] overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-purple-200 dark:scrollbar-thumb-purple-700 scrollbar-track-transparent",children:l.map((e,t)=>(0,a.jsxs)("li",{className:"flex items-start p-3 rounded-md bg-purple-50 text-gray-700 hover:bg-purple-100/50 transition-all duration-200 group relative",children:[(0,a.jsx)("span",{className:"inline-flex items-center justify-center w-5 h-5 rounded-full bg-purple-100 text-purple-600 text-xs font-medium mt-0.5",children:t+1}),(0,a.jsxs)("div",{className:"flex-grow ml-2",children:[(0,a.jsx)("span",{className:"inline-block px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-md mb-1.5",children:e.subject}),(0,a.jsx)("span",{className:"flex-grow whitespace-pre-wrap break-words text-sm group-hover:text-purple-600 transition-colors",children:e.text})]}),(0,a.jsx)("button",{onClick:()=>B(t),className:"absolute right-2 top-2.5 opacity-0 group-hover:opacity-100 transition-opacity","aria-label":"删除第".concat(t+1,"项"),children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 text-gray-400 hover:text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},e.id))})]})})]})})]}),(0,a.jsx)("button",{onClick:()=>{z(!0)},className:"fixed bottom-20 right-4 bg-blue-500 text-white p-3 rounded-full shadow-lg hover:bg-blue-600 z-10",title:"打开AI助手",children:(0,a.jsx)("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,a.jsx)("path",{d:"M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"})})}),(0,a.jsx)("div",{className:"fixed bottom-0 left-0 right-0 p-3 border-t border-gray-200 bg-white/80 backdrop-blur-sm",children:(0,a.jsxs)("div",{className:"w-full max-w-3xl mx-auto",children:[(0,a.jsxs)("div",{className:"mb-2",children:[(0,a.jsx)("label",{htmlFor:"subject-select",className:"text-xs text-gray-500 mr-2",children:"选择科目："}),(0,a.jsx)("select",{id:"subject-select",value:r,onChange:e=>n(e.target.value),disabled:i,className:"px-3 py-1.5 rounded-md border border-gray-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 ".concat(i?"bg-gray-100 cursor-not-allowed":""),children:S.map(e=>(0,a.jsx)("option",{value:e,children:e},e))})]}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("textarea",{ref:x,value:e,onChange:e=>{if(t(e.target.value),x.current){x.current.style.height="auto";let e=Math.max(40,Math.min(x.current.scrollHeight,150));x.current.style.height=e+"px"}},onKeyDown:e=>{O(e)},placeholder:"输入你的学习心得、思考或灵感...",className:"w-full pl-3 pr-14 py-2 rounded-lg border border-gray-200 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none text-sm transition-all duration-300 shadow-sm hover:shadow",disabled:i,style:{height:"40px",overflow:"hidden"}}),(0,a.jsx)("button",{onClick:_,disabled:i||0===e.trim().length,className:"absolute right-3 bottom-3 w-9 h-9 rounded-full flex items-center justify-center transition-all duration-300 transform hover:scale-105 ".concat(i||0===e.trim().length?"bg-gray-200 text-gray-400 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700 shadow hover:shadow-md"),"aria-label":"发送",children:i?(0,a.jsxs)("svg",{className:"animate-spin h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,a.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z",clipRule:"evenodd"})})})]}),(0,a.jsxs)("div",{className:"mt-2 text-xs text-gray-500 flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("kbd",{className:"px-2 py-1 bg-gray-100 rounded-md text-xs font-mono",children:"Ctrl"}),(0,a.jsx)("span",{className:"mx-1",children:"+"}),(0,a.jsx)("kbd",{className:"px-2 py-1 bg-gray-100 rounded-md text-xs font-mono",children:"Enter"}),(0,a.jsx)("span",{className:"ml-2",children:"发送"})]}),(0,a.jsx)("span",{className:"text-gray-400",children:"继续输入或按发送键保存"})]})]})}),(0,a.jsx)("div",{className:"h-40"}),R&&(0,a.jsx)(d,{savedItems:W,onClose:()=>{z(!1)}})]})}}},function(e){e.O(0,[218,64,440,971,117,744],function(){return e(e.s=9713)}),_N_E=e.O()}]);