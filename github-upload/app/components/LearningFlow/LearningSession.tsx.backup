'use client'

import React, { useState, useEffect } from 'react';
import { LearningSession, LearningState, StudentProfile, LearningStep, LearningMaterial } from '../../types/learning';
import { ConversationHistory, CreateConversationRequest } from '../../types/conversation';
import { ConversationService } from '../../services/conversationService';
import { ChatMessage, Role } from '../../utils/chatTypes';
import { createProviderFromEnv } from '../../services/ai';
import type { AIProvider } from '../../services/ai';
import ExplainStep from './ExplainStep';
import ConfirmStep from './ConfirmStep';
import QuizStep from './QuizStep';
import ReviewStep from './ReviewStep';
import ResultStep from './ResultStep';
import toast from 'react-hot-toast';

// å¸¸é‡å®šä¹‰
const DEFAULT_UNDERSTANDING_LEVEL = 3;
const MAX_QUESTION_COUNT = 8;
const MIN_UNDERSTANDING_FOR_NEXT = 4;
const MIN_UNDERSTANDING_WITH_MAX_QUESTIONS = 3;
const DEFAULT_QUIZ_SCORE = 75;

// ç›´æ¥å®šä¹‰LearningFlowServiceç±»ï¼Œé¿å…å¯¼å…¥é—®é¢˜
class LearningFlowService {
  private currentSession: LearningSession | null = null;
  private aiProvider: AIProvider | null = null;

  constructor() {
    // åˆå§‹åŒ–AI Provider
    this.aiProvider = createProviderFromEnv();
  }

  // è¾…åŠ©æ–¹æ³•ï¼šä½¿ç”¨AI Providerå‘é€æ¶ˆæ¯å¹¶è·å–å“åº”
  private async sendAIMessage(prompt: string): Promise<string> {
    if (!this.aiProvider) {
      throw new Error('AI Provider æœªåˆå§‹åŒ–');
    }

    return new Promise((resolve, reject) => {
      let fullResponse = '';
      
      // è®¾ç½®æ¶ˆæ¯å¤„ç†å™¨
      this.aiProvider!.onMessage((message: string, isFinal: boolean) => {
        fullResponse += message;
        if (isFinal) {
          resolve(fullResponse);
        }
      });
      
      // è®¾ç½®é”™è¯¯å¤„ç†å™¨
      this.aiProvider!.onError((error: string) => {
        reject(new Error(error));
      });
      
      // å‘é€æ¶ˆæ¯
      this.aiProvider!.sendMessage(prompt);
    });
  }

  // å¼€å§‹æ–°çš„å­¦ä¹ ä¼šè¯
  async startSession(studentId: string, subject: string, topic: string, learningMaterials?: any[]): Promise<LearningSession> {
    try {
      // å¦‚æœæ²¡æœ‰æä¾›å­¦ä¹ ææ–™ï¼Œç”Ÿæˆé»˜è®¤çš„å­¦ä¹ ææ–™
      if (!learningMaterials || learningMaterials.length === 0) {
        learningMaterials = [{ id: `default_${Date.now()}`, content: `è¿™æ˜¯å…³äº${topic}çš„é»˜è®¤å­¦ä¹ ææ–™ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šä½¿ç”¨çœŸå®çš„å­¦ä¹ å†…å®¹ã€‚`, subject, source: 'default' }];
      }

      const session: LearningSession = {
      id: `session_${Date.now()}`,
      studentId,
      subject,
      topic,
      state: 'EXPLAIN',
      steps: [],
      learningMaterials,
      createdAt: new Date(),
      updatedAt: new Date(),
      questionCount: 0
    };

      this.currentSession = session;
      return session;
    } catch (error) {
      console.error('Failed to start learning session:', error);
      throw error;
    }
  }

  // è·å–å½“å‰ä¼šè¯
  getCurrentSession(): LearningSession | null {
    return this.currentSession;
  }

  // è¿‡æ»¤ç›¸å…³å­¦ä¹ ææ–™çš„å…¬å…±æ–¹æ³•
  private filterRelevantMaterials(topic: string, subject: string): LearningMaterial[] {
    if (!this.currentSession?.learningMaterials) {
      return [];
    }

    return this.currentSession.learningMaterials.filter((material: LearningMaterial) => {
      const content = material.content.toLowerCase();
      const topicLower = topic.toLowerCase();
      const subjectLower = subject.toLowerCase();
      
      // 1. ç›´æ¥åŒ…å«å®Œæ•´ä¸»é¢˜åç§°
      if (content.includes(topicLower)) {
        return true;
      }
      
      // 2. åŒ…å«å­¦ç§‘åç§°
      if (content.includes(subjectLower)) {
        return true;
      }
      
      // 3. æ£€æŸ¥ä¸»é¢˜å…³é”®è¯ï¼ˆæ›´çµæ´»çš„åŒ¹é…ï¼‰
      const topicKeywords = topicLower.split(/[\s\-_çš„]+/).filter(word => word.length > 1);
      const hasTopicKeyword = topicKeywords.some(keyword => content.includes(keyword));
      if (hasTopicKeyword) {
        return true;
      }
      
      // 4. æ£€æŸ¥å­¦ç§‘ç›¸å…³å…³é”®è¯
       const subjectKeywords: Record<string, string[]> = {
         'ç”Ÿç‰©': ['ç»†èƒ', 'åŸºå› ', 'é—ä¼ ', 'ç³»ç»Ÿ', 'å™¨å®˜', 'ç»„ç»‡', 'åˆ†å­', 'è›‹ç™½è´¨', 'dna', 'rna', 'æ¿€ç´ ', 'é…¶', 'ä»£è°¢', 'ç”Ÿç†', 'è§£å‰–'],
         'æ•°å­¦': ['å‡½æ•°', 'æ–¹ç¨‹', 'å‡ ä½•', 'ä»£æ•°', 'ä¸‰è§’', 'æ¦‚ç‡', 'ç»Ÿè®¡', 'å¾®ç§¯åˆ†', 'å¯¼æ•°', 'ç§¯åˆ†', 'å‘é‡', 'çŸ©é˜µ'],
         'ç‰©ç†': ['åŠ›', 'èƒ½é‡', 'ç”µ', 'ç£', 'å…‰', 'å£°', 'çƒ­', 'è¿åŠ¨', 'æ³¢', 'åœº', 'ç²’å­', 'åŸå­'],
         'åŒ–å­¦': ['åŸå­', 'åˆ†å­', 'ç¦»å­', 'é”®', 'ååº”', 'å…ƒç´ ', 'åŒ–åˆç‰©', 'æº¶æ¶²', 'é…¸', 'ç¢±', 'æ°§åŒ–', 'è¿˜åŸ']
       };
       
       const keywords = subjectKeywords[subject] || [];
       const hasSubjectKeyword = keywords.some((keyword: string) => content.includes(keyword));
      if (hasSubjectKeyword) {
        return true;
      }
      
      // 5. å¦‚æœæ˜¯é»˜è®¤ææ–™æˆ–ç”¨æˆ·è¾“å…¥ï¼Œæ€»æ˜¯åŒ…å«
      if (material.source === 'default' || material.source === 'saved_items' || material.source === 'user_input') {
        return true;
      }
      
      return false;
    });
  }

  // æ„å»ºå­¦ä¹ ææ–™å†…å®¹çš„å…¬å…±æ–¹æ³•
  private buildMaterialsContent(materials: LearningMaterial[]): string {
    if (!materials || materials.length === 0) {
      return '';
    }

    return materials
      .map((material: LearningMaterial, index: number) => {
        const source = material.source || '';
        const isUserInput = source === 'user_input';
        const sourceLabel = isUserInput ? 'ã€å­¦ç”Ÿè¾“å…¥å†…å®¹ã€‘' : 
                           source === 'saved_items' ? 'ã€ä¿å­˜çš„å­¦ä¹ ææ–™ã€‘' : 
                           'ã€è¯¾ç¨‹ææ–™ã€‘';
        
        const content = `${sourceLabel} ææ–™${index + 1}ï¼ˆ${material.subject}ï¼‰ï¼š${material.content}`;
        
        if (isUserInput) {
          return content + '\n**é‡è¦æç¤º**ï¼šè¿™æ˜¯å­¦ç”Ÿç›´æ¥è¾“å…¥çš„å­¦ä¹ å†…å®¹ï¼Œè¯·åœ¨è®²è§£ä¸­ç‰¹åˆ«å…³æ³¨å¹¶é‡ç‚¹å›åº”å­¦ç”Ÿçš„å…·ä½“éœ€æ±‚ã€‚';
        }
        
        return content;
      })
      .join('\n\n');
  }

  // ç”ŸæˆçŸ¥è¯†ç‚¹è®²è§£
  private async generateExplanation(topic: string, subject: string): Promise<string> {
    // æ„å»ºå­¦ä¹ ææ–™å†…å®¹ - åªä½¿ç”¨ä¸å½“å‰å­¦ä¹ ä¸»é¢˜ç›¸å…³çš„ææ–™
    const relevantMaterials = this.filterRelevantMaterials(topic, subject);
    const materialsContent = this.buildMaterialsContent(relevantMaterials);

    const prompt = `ğŸ­ è§’è‰²è®¾å®š
ä½ æ˜¯ä¸€åã€ç³»ç»ŸåŒ–AIå­¦ä¹ æ•™ç»ƒã€‘ï¼Œè´Ÿè´£è®²è§£ä»»ä½•å­¦ç§‘æˆ–çŸ¥è¯†ç‚¹ï¼ˆè¯­æ–‡ã€æ•°å­¦ã€è‹±è¯­ã€ç‰©ç†ã€åŒ–å­¦ã€ç”Ÿç‰©ã€å†å²ã€åœ°ç†ã€æ”¿æ²»ã€ç¼–ç¨‹ã€é€šè¯†ç­‰ï¼‰ã€‚
ä½ èåˆè¯¾æœ¬çŸ¥è¯†ã€è€ƒè¯•è¦æ±‚ä¸è·¨å­¦ç§‘åˆ›é€ æ€ç»´ï¼Œå¸®åŠ©æˆ‘çœŸæ­£"å­¦æ‡‚â€”ä¼šç”¨â€”èƒ½è¿ç§»"ã€‚
ä½ çš„èº«ä»½ï¼šæ—¢æ˜¯å­¦éœ¸çº§æ•™ç»ƒï¼Œä¹Ÿæ˜¯å¯å‘å¼å¯¼å¸ˆã€‚

---

ğŸ¯ æ€»ç›®æ ‡
1. è®©æˆ‘çœŸæ­£æŒæ¡å¹¶èƒ½çµæ´»è¿ç”¨çŸ¥è¯†ç‚¹ï¼Œä¸åªæ˜¯çœ‹æ‡‚ï¼Œè€Œæ˜¯èƒ½ç”¨äºè€ƒè¯•ã€ç”Ÿæ´»å’Œåˆ›é€ ã€‚
2. è®²è§£å†…å®¹ç³»ç»ŸåŒ–ã€æœ‰å±‚æ¬¡ï¼Œä»å…¥é—¨åˆ°æ‹”é«˜ï¼Œé…åˆä¾‹é¢˜ä¸åæ€ã€‚
3. å¯é€‰åœ°å¼•å…¥è·¨å­¦ç§‘æˆ–ç”Ÿäº§åˆ›é€ è§†è§’ï¼Œå¸®åŠ©æˆ‘å»ºç«‹æ›´æ·±çš„ç†è§£ä¸å®è·µè¿æ¥ã€‚

---

ğŸ§  å·¥ä½œæ–¹å¼ï¼ˆå­¦ä¹ é—­ç¯ï¼‰
æ•´ä¸ªè®²è§£æŒ‰ä»¥ä¸‹ç»“æ„ç”Ÿæˆï¼Œè¯­è¨€é€šä¿—ã€é€»è¾‘æ¸…æ™°ã€å¾ªåºæ¸è¿›ã€‚

å½“å‰å­¦ä¹ ä¸»é¢˜ï¼š**${topic}**ï¼ˆ${subject}å­¦ç§‘ï¼‰

${materialsContent ? `## ğŸ“– è¯¾ç¨‹ææ–™ï¼ˆå¿…é¡»å¯¹é½ï¼‰
ä»¥ä¸‹ææ–™ä¸ºè®²è§£çš„â€œå”¯ä¸€å‡†ç»³â€ï¼Œè¯·æŠ½å–å…¶ä¸­çš„å®šä¹‰ã€ç»“è®ºã€ä¾‹é¢˜è¦ç‚¹ï¼Œå¹¶åœ¨å¯¹åº”æ¡ç›®æ ‡æ³¨ **ã€ææ–™å¯¹é½ã€‘**ï¼š
${materialsContent}
> è‹¥ææ–™ä¸å¸¸è¯†å†²çªï¼Œä»¥ææ–™ä¸ºå‡†ï¼›è‹¥ææ–™ç¼ºå¤±ä¿¡æ¯ï¼Œå¯åœ¨ä¸å†²çªå‰æä¸‹è¡¥å……ä¸¥è°¨å¸¸è¯†ã€‚` : ''}

ã€ä¸€å¥è¯æ€»è§ˆâ€”â€”æ€ç»´å¯¼å›¾â€”â€”çŸ¥è¯†æ¡†æ¶ã€‘
ç³»ç»Ÿæ„å»ºâ€”â€”è®²æ¸…è¿™ä¸ªçŸ¥è¯†ç‚¹çš„æ ¸å¿ƒå«ä¹‰ã€æ¡†æ¶

ã€çŸ¥è¯†ç»“æ„åŒ–è¯¦ç»†åˆ†ç‚¹è®²è§£ã€‘ï¼ˆæ ¹æ®å®é™…æƒ…å†µä¾§é‡äºå“ªéƒ¨åˆ†çš„è®²è§£ï¼‰
1. å…³é”®æ¦‚å¿µã€çŸ¥è¯†ç‚¹
2. åŸç†æˆ–æ¨ç†é€»è¾‘
3. è§£é¢˜æ–¹æ³•æˆ–æ­¥éª¤
4. å®ä¾‹æˆ–ç”Ÿæ´»åº”ç”¨ï¼ˆé€‰ã€ç•¥ï¼‰

ã€å½¢å¼åŒ–è¡¨è¾¾ã€‘
ç”¨æœ€åˆé€‚çš„è¡¨è¾¾æ–¹å¼å‘ˆç°ï¼š
- æ•°ç†ç±» â†’ å…¬å¼ / å®šä¹‰ / ç¬¦å·
- è¯­è¨€ç±» â†’ è¯­æ³• / èŒƒå¼ / ä¾‹å¥
- äººæ–‡ç±» â†’ æ¡†æ¶ / å› æœé“¾ / è¯æ®ç±»å‹

ã€ç›´è§‚ç†è§£ã€‘
ç”¨ä¾‹å­ã€å›¾åƒã€ç±»æ¯”ã€è¡¨æ ¼ç­‰æ–¹å¼å¸®æˆ‘"çœ‹è§"çŸ¥è¯†çš„å½¢çŠ¶ã€‚

ã€æ–¹æ³•è®ºï½œå¦‚ä½•å¾—åˆ°æˆ–éªŒè¯ã€‘
åˆ—å‡ºéªŒè¯æ–¹æ³•æˆ–æ¨ç†æ­¥éª¤ï¼Œè®©æˆ‘ç†è§£ç»“è®ºä»ä½•è€Œæ¥ã€‚

ã€é«˜é¢‘é¢˜å‹ä¸è§£æ³•å¥—è·¯ã€‘
æ€»ç»“è€ƒè¯•ä¸­æœ€å¸¸è€ƒçš„2~3ç±»é¢˜å‹ï¼Œå¹¶æç‚¼å‡º"è¯†åˆ«ä¿¡å· + ä¸‰æ­¥è§£æ³•"ã€‚

ã€ä¾‹é¢˜è®²è§£ã€‘
â€¢ é¢˜ç›®
â€¢ åˆ†æ­¥æç¤ºï¼ˆä»æ€è·¯å‡ºå‘å¼•å¯¼æˆ‘ï¼‰
â€¢ å®Œæ•´è§£æï¼ˆå†™å‡ºæ¨å¯¼ã€è¿‡ç¨‹ã€ç­”æ¡ˆï¼‰
â€¢ å»¶ä¼¸é¢˜ï¼šç»™1ä¸ªå˜å¼é¢˜æˆ–æ‹“å±•æƒ…å¢ƒ

ã€æ˜“é”™ç‚¹æé†’ã€‘
åˆ—å‡º3ä¸ªæœ€å¸¸è§çš„é”™è¯¯ï¼Œå¹¶é™„"æ­£ç¡®åšæ³•"ã€‚

ã€æ‹”é«˜ä¸ç«èµ›æ‹“å±•ã€‘
è¯´æ˜"æ€ç»´è·³è·ƒç‚¹"ï¼Œå¹¶æä¾›1ä¸ªæ›´é«˜å±‚æ¬¡çš„é¢˜ç›®æˆ–æ¢ç©¶æ–¹å‘ã€‚

ã€è·¨å­¦ç§‘ä¸ç”Ÿäº§åˆ›é€ åº”ç”¨ã€‘
å±•ç¤ºè¯¥çŸ¥è¯†åœ¨å…¶ä»–å­¦ç§‘æˆ–å®é™…ä¸­çš„ç”¨é€”ï¼Œä¾‹å¦‚ï¼š
- ç‰©ç†åŸç† â†’ åº”ç”¨äºå·¥ç¨‹æˆ–AIä¼˜åŒ–
- æ•°å­¦æ¨¡å‹ â†’ åº”ç”¨äºç»æµæˆ–ç®—æ³•
- å†å²è§„å¾‹ â†’ å¯å‘ç¤¾ä¼šå†³ç­–æˆ–äº§å“åˆ›æ–°
åŠ¡å®å¯è½åœ°ï¼Œé¿å…ç©ºæ³›æ¯”å–»ã€‚

ã€å¤ç›˜ä¸è¡ŒåŠ¨å¡ã€‘
1. ä»Šå¤©æˆ‘æœ€æ¸…æ™°çš„çŸ¥è¯†æ¨¡å‹æ˜¯ä»€ä¹ˆï¼Ÿ
2. æˆ‘çš„ç“¶é¢ˆæ˜¯éš¾åº¦ / ç›²åŒº / é€Ÿåº¦ï¼Ÿ
3. ç»™å‡º3æ­¥è¡¥æ•‘è¡ŒåŠ¨ã€‚
â†’ æœ€ç»ˆç”Ÿæˆä¸€å¼ è¡ŒåŠ¨å¡ï¼šç›®æ ‡ï½œä¸¤æ­¥æ‰§è¡Œï½œæˆªæ­¢æ—¶é—´ï½œçªç ´ç‚¹ã€‚

ğŸ“¦ é”™é¢˜ç®¡ç†ä¸å¤ç›˜
1. è‡ªåŠ¨è®°å½•ï¼šç« èŠ‚ï½œçŸ¥è¯†ç‚¹ï½œéš¾åº¦ï½œé”™å› ï½œè¡¥æ•‘è¡ŒåŠ¨ã€‚
2. æ¯å‘¨ç”Ÿæˆ"é”™é¢˜æ¸…å• + æ˜“é”™ç‚¹åˆ†æ + è¡¥æ•‘æ–¹æ¡ˆ"ã€‚

## ğŸ“ å†™ä½œä¸æ ¼å¼
- ç”¨ä¸­æ–‡ï¼›æ ‡é¢˜ç”¨â€œ###â€ï¼›**åŠ ç²—**æ ¸å¿ƒæœ¯è¯­ï¼›åˆ—è¡¨ç”¨â€œ- / *â€ï¼›é‡è¦æç¤ºç”¨â€œ>â€
- æœ¯è¯­é¦–æ¬¡å‡ºç°éœ€ç»™å‡º**ç¬¦å·/å•ä½/å®šä¹‰**
- ä¾‹é¢˜è¿‡ç¨‹é‡Œå¯¹å…³é”®ä¸­é—´é‡ä¸åˆ¤æ®**åŠ ç²—**
- **å­—æ•°ç›®æ ‡ï¼š500â€“600å­—**ï¼ˆä¿¡æ¯å¯†åº¦é«˜ä¸”å¥å­ç®€æ´ï¼‰

## âœ… è´¨é‡çº¢çº¿ï¼ˆç”Ÿæˆå‰è‡ªæ£€ï¼‰
1) æœ‰**å±‚çº§çŸ¥è¯†æ ‘**ä¸”ä¸ææ–™ä¸€è‡´ï¼›2) è§£é¢˜æµç¨‹**å¯å¤ç”¨**è€Œéåªå¯¹å•é¢˜æœ‰æ•ˆï¼›
3) æ¯æ¡ç»“è®º/å…¬å¼éƒ½æœ‰**é€‚ç”¨æ¡ä»¶**ï¼›4) ä¾‹é¢˜æ­¥éª¤**å¯é€æ­¥å¤æ ¸**å¹¶å«æœ€ç»ˆè‡ªæ£€ï¼›
5) ä½¿ç”¨äº†ææ–™åˆ™åœ¨æ¡ç›®åæ ‡ **ã€ææ–™å¯¹é½ã€‘**ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸Šç»“æ„ï¼Œå¯¹â€œ${topic}â€è¾“å‡ºä¸“ä¸šã€å‡†ç¡®ã€ç³»ç»Ÿçš„è®²è§£ã€‚`;

    try {
      console.log('[LearningFlowService] å¼€å§‹ç”Ÿæˆè®²è§£å†…å®¹ï¼Œä¸»é¢˜:', topic, 'å­¦ç§‘:', subject);
      
      // ä½¿ç”¨Xunfei APIç”Ÿæˆè®²è§£å†…å®¹
      const content = await this.sendAIMessage(prompt);
      
      if (content && content.trim()) {
        console.log('[LearningFlowService] æˆåŠŸç”Ÿæˆè®²è§£å†…å®¹ï¼Œé•¿åº¦:', content.length);
        return content;
      } else {
        console.warn('[LearningFlowService] APIè¿”å›ç©ºå†…å®¹ï¼Œä½¿ç”¨fallback');
        return this.generateFallbackExplanation(topic, subject);
      }
    } catch (error) {
      console.error('[LearningFlowService] AIç”Ÿæˆè®²è§£å†…å®¹å‡ºé”™:', error);
      // å‡ºé”™æ—¶è¿”å›æ›´è¯¦ç»†çš„fallbackå†…å®¹
      return this.generateFallbackExplanation(topic, subject);
    }
  }

  // ç”Ÿæˆfallbackè®²è§£å†…å®¹
  private generateFallbackExplanation(topic: string, subject: string): string {
    return `### ğŸ“š æ ¸å¿ƒæ¦‚å¿µ
**${topic}**æ˜¯${subject}ä¸­çš„é‡è¦æ¦‚å¿µï¼Œéœ€è¦æˆ‘ä»¬æ·±å…¥ç†è§£å’ŒæŒæ¡ã€‚

### ğŸ¯ ä¸ºä»€ä¹ˆé‡è¦
åœ¨${subject}å­¦ä¹ ä¸­ï¼Œ${topic}æ˜¯åŸºç¡€çŸ¥è¯†ç‚¹ï¼Œå¯¹åç»­å­¦ä¹ å…·æœ‰é‡è¦æ„ä¹‰ã€‚

### ğŸ’¡ å…³é”®è¦ç‚¹
* **åŸºæœ¬å®šä¹‰**ï¼š${topic}çš„åŸºæœ¬å«ä¹‰å’Œç‰¹å¾
* **é‡è¦æ€§è´¨**ï¼š${topic}å…·æœ‰çš„ä¸»è¦æ€§è´¨å’Œè§„å¾‹
* **åº”ç”¨æ–¹æ³•**ï¼šå¦‚ä½•åœ¨å®é™…é—®é¢˜ä¸­è¿ç”¨${topic}

### âš ï¸ æ³¨æ„äº‹é¡¹
> å­¦ä¹ ${topic}æ—¶ï¼Œéœ€è¦æ³¨æ„ç†è§£å…¶æœ¬è´¨å«ä¹‰ï¼Œé¿å…æ­»è®°ç¡¬èƒŒï¼Œè¦é€šè¿‡ç»ƒä¹ åŠ æ·±ç†è§£ã€‚

*æ³¨ï¼šå½“å‰æ˜¾ç¤ºçš„æ˜¯é»˜è®¤å†…å®¹ï¼Œå®é™…ä½¿ç”¨ä¸­ä¼šç”±AIç”Ÿæˆæ›´è¯¦ç»†çš„è®²è§£ã€‚*`;
  }

  // ç”Ÿæˆè‹æ ¼æ‹‰åº•å¼æé—®

  // è¯„ä¼°å­¦ç”Ÿå›ç­”çš„æ–¹æ³•ï¼Œæ”¹è¿›é”™è¯¯å¤„ç†
  private async evaluateStudentAnswer(topic: string, subject: string, studentAnswer: string): Promise<{
    understanding: number;
    feedback: string;
    nextQuestion: string;
    moveNext: boolean;
  }> {
    const questionCount = this.currentSession?.questionCount || 0;
    
    // æ„å»ºå­¦ä¹ ææ–™å†…å®¹
    const relevantMaterials = this.filterRelevantMaterials(topic, subject);
    const materialsContent = this.buildMaterialsContent(relevantMaterials);

    const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è‹æ ¼æ‹‰åº•å¼AIæ•™ç»ƒï¼Œä¸“é—¨é’ˆå¯¹${subject}å­¦ç§‘çš„å­¦ä¹ ã€‚
å­¦ç”Ÿæ­£åœ¨å­¦ä¹ "${topic}"è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼Œç°åœ¨å›ç­”äº†ä½ çš„é—®é¢˜ï¼š"${studentAnswer}"

åŸºäºä»¥ä¸‹å­¦ä¹ ææ–™ï¼š
${materialsContent}

è¯·è¯„ä¼°å­¦ç”Ÿçš„å›ç­”å¹¶ç”Ÿæˆä¸‹ä¸€æ­¥çš„å¼•å¯¼ã€‚è¯·ä»¥JSONæ ¼å¼å›å¤ï¼š

{
  "understanding": æ•°å­—(1-5ï¼Œè¡¨ç¤ºç†è§£ç¨‹åº¦),
  "feedback": "å¯¹å­¦ç”Ÿå›ç­”çš„åé¦ˆ",
  "nextQuestion": "ä¸‹ä¸€ä¸ªè‹æ ¼æ‹‰åº•å¼é—®é¢˜",
  "moveNext": å¸ƒå°”å€¼(æ˜¯å¦å¯ä»¥è¿›å…¥ä¸‹ä¸€é˜¶æ®µ)
}

è¯„ä¼°æ ‡å‡†ï¼š
1. **ç†è§£ç¨‹åº¦è¯„åˆ†**ï¼š
   - è¡¨é¢ç†è§£ï¼šèƒ½å¤è¿°åŸºæœ¬æ¦‚å¿µ
   - æ·±åº¦ç†è§£ï¼šæ˜¯å¦ç†è§£åŸç†å’Œæœ¬è´¨
   - åº”ç”¨èƒ½åŠ›ï¼šèƒ½å¦ä¸¾ä¾‹æˆ–åº”ç”¨åˆ°å®é™…æƒ…å†µ
   - è¡¨è¾¾æ¸…æ™°åº¦ï¼šé€»è¾‘æ˜¯å¦æ¸…æ¥š

2. **è¿›åº¦æ§åˆ¶**ï¼š
   - å¦‚æœunderstanding >= ${MIN_UNDERSTANDING_FOR_NEXT}ï¼Œè®¾ç½®moveNextä¸ºtrue
   - å¦‚æœå·²æé—®è¶…è¿‡${MAX_QUESTION_COUNT}æ¬¡ä¸”understanding >= ${MIN_UNDERSTANDING_WITH_MAX_QUESTIONS}ï¼Œè®¾ç½®moveNextä¸ºtrue
   - å¦‚æœå­¦ç”Ÿå›ç­”æ˜¾ç¤ºæ·±åº¦ç†è§£ï¼Œå¯ä»¥æå‰è®¾ç½®moveNextä¸ºtrue

3. **ä¸‹ä¸€ä¸ªé—®é¢˜**ï¼ˆå¦‚æœmoveNextä¸ºfalseï¼‰ï¼š
   - èšç„¦äºè€ƒè¯•é‡ç‚¹å’Œæ ¸å¿ƒæ¦‚å¿µ
   - é¿å…è¿‡äºåé—¨çš„ç§‘å­¦é—®é¢˜
   - æ ¹æ®å­¦ç”Ÿå½“å‰ç†è§£æ°´å¹³è°ƒæ•´éš¾åº¦
   - é—®é¢˜è¦å…·ä½“ã€æœ‰é’ˆå¯¹æ€§

è¯·ç¡®ä¿è¿”å›æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚`;

    try {
      const content = await this.sendAIMessage(prompt);
      
      try {
        const result = JSON.parse(content);
        return {
          understanding: Math.max(1, Math.min(5, result.understanding || DEFAULT_UNDERSTANDING_LEVEL)),
          feedback: result.feedback || 'ç»§ç»­åŠªåŠ›ï¼',
          nextQuestion: result.nextQuestion || 'è¯·ç»§ç»­æ€è€ƒè¿™ä¸ªé—®é¢˜ã€‚',
          moveNext: result.moveNext || false
        };
      } catch (parseError) {
        console.error('[LearningFlowService] JSONè§£æé”™è¯¯:', parseError);
        return this.getDefaultEvaluation(topic, questionCount);
      }
    } catch (error) {
      console.error('[LearningFlowService] è¯„ä¼°å­¦ç”Ÿå›ç­”å‡ºé”™:', error);
    }

    return this.getDefaultEvaluation(topic, questionCount);
  }

  // è·å–é»˜è®¤è¯„ä¼°ç»“æœçš„æ–¹æ³•
  private getDefaultEvaluation(topic: string, questionCount: number) {
    return {
      understanding: DEFAULT_UNDERSTANDING_LEVEL,
      feedback: 'ä½ çš„å›ç­”æœ‰ä¸€å®šé“ç†ï¼Œè®©æˆ‘ä»¬ç»§ç»­æ·±å…¥æ¢è®¨ã€‚',
      nextQuestion: `å…³äº${topic}ï¼Œä½ èƒ½ä¸¾ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥è¯´æ˜å—ï¼Ÿ`,
      moveNext: questionCount >= MAX_QUESTION_COUNT
    };
  }

  private async generateSocraticQuestion(topic: string, subject: string, studentQuestion: string): Promise<string> {
    // è¿‡æ»¤ä¸å½“å‰å­¦ä¹ ä¸»é¢˜ç›¸å…³çš„å­¦ä¹ ææ–™
    const relevantMaterials = this.filterRelevantMaterials(topic, subject);

    // æ„å»ºç›¸å…³å­¦ä¹ ææ–™å†…å®¹
    const materialsContent = relevantMaterials.length > 0 
      ? this.buildMaterialsContent(relevantMaterials)
      : `å½“å‰å­¦ä¹ ä¸»é¢˜ï¼š${topic}ï¼ˆ${subject}å­¦ç§‘ï¼‰`;

    const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è‹æ ¼æ‹‰åº•å¼AIæ•™ç»ƒï¼Œä¸“é—¨é’ˆå¯¹${subject}å­¦ç§‘çš„å­¦ä¹ ã€‚

${relevantMaterials.length > 0 ? 'ç›¸å…³å­¦ä¹ ææ–™ï¼š' : 'å­¦ä¹ ä¸»é¢˜ï¼š'}
${materialsContent}

å½“å‰çŸ¥è¯†ç‚¹ï¼š${topic}
å­¦ç”Ÿå›ç­”/é—®é¢˜ï¼š${studentQuestion}

è¯·ç”Ÿæˆä¸€ä¸ªé«˜è´¨é‡çš„è‹æ ¼æ‹‰åº•å¼å¼•å¯¼é—®é¢˜ï¼Œè¦æ±‚ï¼š

1. **ç¬¦åˆè€ƒæƒ…**ï¼šé—®é¢˜åº”è¯¥ä¸${subject}å­¦ç§‘çš„è€ƒè¯•è¦æ±‚å’ŒçŸ¥è¯†ä½“ç³»ç›¸ç¬¦
2. **å±‚æ¬¡é€’è¿›**ï¼šæ ¹æ®å­¦ç”Ÿå½“å‰ç†è§£æ°´å¹³ï¼Œè®¾è®¡é€‚å½“éš¾åº¦çš„é—®é¢˜
3. **å¯å‘æ€è€ƒ**ï¼šä¸ç›´æ¥ç»™ç­”æ¡ˆï¼Œè€Œæ˜¯å¼•å¯¼å­¦ç”Ÿè‡ªå·±å‘ç°å’Œç†è§£
4. **å…·ä½“å®ç”¨**ï¼šé—®é¢˜è¦å…·ä½“ã€æœ‰é’ˆå¯¹æ€§ï¼Œé¿å…è¿‡äºæŠ½è±¡
5. **å¾ªåºæ¸è¿›**ï¼šä»ç®€å•æ¦‚å¿µå¼€å§‹ï¼Œé€æ­¥æ·±å…¥åˆ°å¤æ‚åº”ç”¨

é—®é¢˜ç±»å‹å¯ä»¥åŒ…æ‹¬ï¼š
- æ¦‚å¿µç†è§£ç±»ï¼šå¸®åŠ©å­¦ç”Ÿç†è§£åŸºæœ¬æ¦‚å¿µ
- å…³è”åˆ†æç±»ï¼šå¼•å¯¼å­¦ç”Ÿæ€è€ƒçŸ¥è¯†ç‚¹ä¹‹é—´çš„è”ç³»
- åº”ç”¨å®è·µç±»ï¼šè®©å­¦ç”Ÿæ€è€ƒå¦‚ä½•åœ¨å®é™…æƒ…å†µä¸­åº”ç”¨
- å¯¹æ¯”åˆ†æç±»ï¼šé€šè¿‡å¯¹æ¯”åŠ æ·±ç†è§£
- åŸå› æ¢ç©¶ç±»ï¼šå¼•å¯¼å­¦ç”Ÿæ€è€ƒ"ä¸ºä»€ä¹ˆ"

è¯·ç”Ÿæˆä¸€ä¸ªç®€æ´æ˜äº†çš„å¼•å¯¼æ€§é—®é¢˜ï¼ˆæ§åˆ¶åœ¨50å­—ä»¥å†…ï¼‰ï¼š`;

    try {
      const content = await this.sendAIMessage(prompt);
      return content || `è®©æˆ‘ä»¬ä»ä¸€ä¸ªåŸºç¡€é—®é¢˜å¼€å§‹ï¼šä½ è®¤ä¸º${topic}çš„æ ¸å¿ƒç‰¹å¾æ˜¯ä»€ä¹ˆï¼Ÿ`;
    } catch (error) {
      console.error('[LearningFlowService] ç”Ÿæˆè‹æ ¼æ‹‰åº•å¼æé—®å‡ºé”™:', error);
      return `è®©æˆ‘ä»¬ä»ä¸€ä¸ªåŸºç¡€é—®é¢˜å¼€å§‹ï¼šä½ è®¤ä¸º${topic}çš„æ ¸å¿ƒç‰¹å¾æ˜¯ä»€ä¹ˆï¼Ÿ`;
    }
  }

  // ç”Ÿæˆé»˜è®¤æµ‹éªŒé¢˜ç›®çš„å…¬å…±æ–¹æ³•
  private generateDefaultQuestions(topic: string, subject: string): any[] {
    return [
      {
        id: '1',
        question: `å…³äº${topic}ï¼Œä»¥ä¸‹å“ªä¸ªè¯´æ³•æ˜¯æ­£ç¡®çš„ï¼Ÿ`,
        type: 'multiple_choice',
        options: ['è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µ', 'è¿™ä¸ªæ¦‚å¿µä¸é‡è¦', 'è¿™ä¸ªæ¦‚å¿µå¾ˆéš¾ç†è§£', 'è¿™ä¸ªæ¦‚å¿µæ²¡æœ‰å®é™…åº”ç”¨'],
        correctAnswer: 0,
        explanation: `${topic}ç¡®å®æ˜¯ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œåœ¨${subject}ä¸­æœ‰å¹¿æ³›çš„åº”ç”¨ã€‚`
      },
      {
        id: '2',
        question: `${topic}åœ¨å®é™…ç”Ÿæ´»ä¸­æœ‰åº”ç”¨ã€‚`,
        type: 'true_false',
        options: ['æ­£ç¡®', 'é”™è¯¯'],
        correctAnswer: 0,
        explanation: `${topic}åœ¨å®é™…ç”Ÿæ´»ä¸­ç¡®å®æœ‰å¾ˆå¤šåº”ç”¨ï¼Œæ˜¯ä¸€ä¸ªå®ç”¨çš„çŸ¥è¯†ç‚¹ã€‚`
      }
    ];
  }

  // é”™è¯¯å¤„ç†çš„å…¬å…±æ–¹æ³•
  private handleQuizGenerationError(error: any, topic: string, subject: string): any[] {
    console.error('[LearningFlowService] ç”Ÿæˆæµ‹éªŒé¢˜ç›®å‡ºé”™:', error);
    return this.generateDefaultQuestions(topic, subject);
  }

  // ç”Ÿæˆæµ‹éªŒé¢˜ç›®
  private async generateQuiz(topic: string, subject: string): Promise<any[]> {
    console.log('[LearningFlowService] å¼€å§‹ç”Ÿæˆæµ‹éªŒé¢˜ç›®ï¼Œä¸»é¢˜:', topic, 'å­¦ç§‘:', subject);
    
    // è¿‡æ»¤ä¸å½“å‰ä¸»é¢˜ç›¸å…³çš„å­¦ä¹ ææ–™
    const relevantMaterials = this.filterRelevantMaterials(topic, subject);

    // æ„å»ºå­¦ä¹ ææ–™å†…å®¹
    const materialsContent = this.buildMaterialsContent(relevantMaterials);

    const prompt = `è¯·åŸºäº"${topic}"è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼Œç”Ÿæˆ5é“æµ‹éªŒé¢˜ï¼Œé¢˜å‹æ··åˆï¼ˆé€‰æ‹©é¢˜ã€åˆ¤æ–­é¢˜ï¼‰ã€‚
è¯·æ ¹æ®ä»¥ä¸‹å­¦ä¹ ææ–™ç”Ÿæˆé¢˜ç›®ï¼š

${materialsContent}

è¯·ä»¥JSONæ ¼å¼å›å¤ï¼ŒåŒ…å«é¢˜ç›®ã€ç±»å‹ã€é€‰é¡¹ã€æ­£ç¡®ç­”æ¡ˆå’Œè§£æï¼š

[
  {
    "id": "1",
    "question": "é¢˜ç›®å†…å®¹",
    "type": "multiple_choice",
    "options": ["é€‰é¡¹A", "é€‰é¡¹B", "é€‰é¡¹C", "é€‰é¡¹D"],
    "correctAnswer": 0,
    "explanation": "è§£æ"
  },
  {
    "id": "2", 
    "question": "åˆ¤æ–­é¢˜å†…å®¹",
    "type": "true_false",
    "options": ["æ­£ç¡®", "é”™è¯¯"],
    "correctAnswer": 0,
    "explanation": "è§£æ"
  }
]

æ³¨æ„ï¼š
1. correctAnswer æ˜¯é€‰é¡¹çš„ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰
2. é¢˜ç›®è¦åŸºäºå­¦ä¹ ææ–™ï¼Œç¡®ä¿å‡†ç¡®æ€§
3. é€‰é¡¹è¦æœ‰ä¸€å®šçš„è¿·æƒ‘æ€§ï¼Œä½†æ­£ç¡®ç­”æ¡ˆè¦æ˜ç¡®
4. è§£æè¦è¯¦ç»†è¯´æ˜ä¸ºä»€ä¹ˆè¿™ä¸ªç­”æ¡ˆæ˜¯æ­£ç¡®çš„`;

    try {
      console.log('[LearningFlowService] å‘é€æµ‹éªŒç”Ÿæˆè¯·æ±‚åˆ°AI');
      
      const content = await this.sendAIMessage(prompt);
      console.log('[LearningFlowService] æµ‹éªŒç”ŸæˆAIå“åº”:', content);
      
      if (content && content.trim()) {
        try {
          // å°è¯•è§£æJSON
          const parsed = JSON.parse(content);
          console.log('[LearningFlowService] æˆåŠŸè§£ææµ‹éªŒé¢˜ç›®JSON:', parsed);
            
            if (Array.isArray(parsed) && parsed.length > 0) {
              // éªŒè¯é¢˜ç›®æ ¼å¼
              const validQuestions = parsed.filter(q => 
                q.id && q.question && q.type && q.options && 
                Array.isArray(q.options) && q.options.length > 0 &&
                typeof q.correctAnswer === 'number' && q.explanation
              );
              
              if (validQuestions.length > 0) {
                console.log('[LearningFlowService] éªŒè¯é€šè¿‡çš„é¢˜ç›®æ•°é‡:', validQuestions.length);
                return validQuestions;
              } else {
                console.warn('[LearningFlowService] æ²¡æœ‰æœ‰æ•ˆçš„é¢˜ç›®ï¼Œä½¿ç”¨é»˜è®¤é¢˜ç›®');
                return this.generateDefaultQuestions(topic, subject);
              }
            } else {
              console.warn('[LearningFlowService] è§£æç»“æœä¸æ˜¯æœ‰æ•ˆæ•°ç»„ï¼Œä½¿ç”¨é»˜è®¤é¢˜ç›®');
              return this.generateDefaultQuestions(topic, subject);
            }
          } catch (parseError) {
            console.error('[LearningFlowService] è§£ææµ‹éªŒé¢˜ç›®JSONå¤±è´¥:', parseError);
            console.log('[LearningFlowService] åŸå§‹å†…å®¹:', content);
            return this.generateDefaultQuestions(topic, subject);
          }
        } else {
          console.warn('[LearningFlowService] AIè¿”å›ç©ºå†…å®¹ï¼Œä½¿ç”¨é»˜è®¤é¢˜ç›®');
          return this.generateDefaultQuestions(topic, subject);
        }
    } catch (error) {
      console.error('[LearningFlowService] æµ‹éªŒç”Ÿæˆç½‘ç»œé”™è¯¯:', error);
      return this.handleQuizGenerationError(error, topic, subject);
    }
  }

  // å¤„ç†å­¦ä¹ æµç¨‹çš„ä¸‹ä¸€æ­¥
  async nextStep(sessionId: string, currentState: LearningState, userInput: string, isQuestion: boolean = false): Promise<{
    nextState: LearningState;
    content: string;
    data?: any;
  }> {
    if (!this.currentSession || this.currentSession.id !== sessionId) {
      throw new Error('æ— æ•ˆçš„å­¦ä¹ ä¼šè¯');
    }

    // è®°å½•å½“å‰æ­¥éª¤
    const step: any = {
      id: `step_${Date.now()}`,
      sessionId,
      step: currentState,
      input: { userInput, isQuestion },
      output: {},
      createdAt: new Date()
    };

    let nextState: LearningState = currentState;
    let content = '';
    let data: any;

    switch (currentState) {
      case 'EXPLAIN':
        // å¦‚æœæ˜¯ç”¨æˆ·æé—®ï¼Œç”Ÿæˆé’ˆå¯¹æ€§è§£é‡Š
        if (isQuestion) {
          // å¢åŠ é—®é¢˜è®¡æ•°
          this.currentSession.questionCount = (this.currentSession.questionCount || 0) + 1;
          
          const prompt = `å­¦ç”Ÿå¯¹"${this.currentSession.topic}"ï¼ˆ${this.currentSession.subject}ï¼‰æœ‰ä»¥ä¸‹ç–‘é—®ï¼š"${userInput}"ã€‚è¯·ç”Ÿæˆä¸€ä¸ªæ¸…æ™°ã€è¯¦ç»†çš„è§£ç­”ï¼Œå¸®åŠ©å­¦ç”Ÿç†è§£è¿™ä¸ªé—®é¢˜ã€‚
è¦æ±‚ï¼š
1. è§£é‡Šè¦ç®€å•æ˜“æ‡‚ï¼Œé¿å…ä½¿ç”¨è¿‡äºä¸“ä¸šçš„æœ¯è¯­
2. æä¾›å…·ä½“çš„ä¾‹å­å¸®åŠ©ç†è§£
3. ä¿æŒè§£ç­”åœ¨200å­—ä»¥å†…
4. ç›´æ¥å›ç­”é—®é¢˜ï¼Œä¸è¦ç”¨æé—®çš„æ–¹å¼å›ç­”å­¦ç”Ÿï¼Œä¹Ÿä¸è¦é—®å­¦ç”Ÿä»»ä½•é—®é¢˜ï¼Œå›å¤å†…å®¹ä¸­ä¸å…è®¸åŒ…å«ä»»ä½•é—®å¥
5. ä½¿ç”¨Markdownæ ¼å¼å¢å¼ºå¯è¯»æ€§ï¼ŒåŒ…æ‹¬**åŠ ç²—**é‡ç‚¹å†…å®¹ã€åˆ—è¡¨ç­‰
6. ç¡®ä¿å›ç­”å†…å®¹èƒ½å¤Ÿå®Œå…¨è§£å†³å­¦ç”Ÿçš„ç–‘é—®ï¼Œå†…å®¹è¦å‡†ç¡®ã€æœ‰é’ˆå¯¹æ€§`;
          
          try {
            content = await this.sendAIMessage(prompt);
          } catch (error) {
            console.error('[LearningFlowService] ç”Ÿæˆé—®é¢˜è§£ç­”å‡ºé”™:', error);
            content = `è¿™é‡Œæ˜¯å¯¹æ‚¨é—®é¢˜çš„è§£ç­”ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šç”±AIç”Ÿæˆè¯¦ç»†çš„å›ç­”ã€‚`;
          }
          step.output = { explanation: content, question: userInput };
          // ä¿æŒåœ¨EXPLAINçŠ¶æ€ï¼Œè®©å­¦ç”Ÿç»§ç»­æé—®æˆ–ç†è§£
          nextState = 'EXPLAIN';
        } else {
          // å­¦ç”Ÿç‚¹å‡»"æˆ‘å·²ç†è§£ï¼Œç»§ç»­"æŒ‰é’®ï¼Œå‡†å¤‡è¿›å…¥çŸ¥è¯†ç¡®è®¤ç¯èŠ‚
          if (userInput === 'NEXT_TO_CONFIRM' || userInput.includes('æˆ‘å·²ç†è§£') || userInput.includes('ç»§ç»­')) {
            // è¿›å…¥çŸ¥è¯†ç¡®è®¤ç¯èŠ‚ï¼Œç”ŸæˆçŸ¥è¯†å¤§çº²
            content = 'æ­£åœ¨ä¸ºä½ ç”ŸæˆçŸ¥è¯†å¤§çº²...';
            step.output = { transitionToConfirm: true };
            nextState = 'CONFIRM';
          } else {
            // åˆå§‹è®²è§£é˜¶æ®µ
            const explanation = await this.generateExplanation(this.currentSession.topic, this.currentSession.subject);
            content = explanation;
            step.output = { explanation };
            // ä¿æŒåœ¨EXPLAINçŠ¶æ€ï¼Œç­‰å¾…å­¦ç”Ÿç†è§£å¹¶ç‚¹å‡»ç»§ç»­
            nextState = 'EXPLAIN';
          }
        }
        break;

      case 'CONFIRM':
        // æ£€æŸ¥ç”¨æˆ·è¾“å…¥ç±»å‹
        if (userInput.includes('ç¡®è®¤ç†è§£') || userInput.includes('è¿›è¡Œæµ‹éªŒ') || userInput.includes('å¼€å§‹æµ‹éªŒ')) {
          // ç”¨æˆ·ç¡®è®¤ç†è§£ï¼Œç›´æ¥è¿›å…¥æµ‹éªŒ
          nextState = 'QUIZ';
          content = 'å¾ˆå¥½ï¼ä½ å·²ç»ç¡®è®¤ç†è§£äº†çŸ¥è¯†ç‚¹ã€‚ç°åœ¨è®©æˆ‘ä»¬é€šè¿‡æµ‹éªŒæ¥éªŒè¯ä½ çš„å­¦ä¹ æˆæœã€‚';
          step.output = { 
            confirmed: true,
            message: content,
            transitionToQuiz: true 
          };
          data = { 
            confirmed: true,
            moveNext: true
          };
        } else if (userInput.includes('ç»§ç»­è®²è§£') || userInput.includes('æ²¡å¬æ‡‚') || userInput.includes('ä¸ç†è§£')) {
          // ç”¨æˆ·éœ€è¦ç»§ç»­è®²è§£ï¼Œè¿”å›EXPLAINçŠ¶æ€
          nextState = 'EXPLAIN';
          content = 'å¥½çš„ï¼Œè®©æˆ‘ä¸ºä½ ç»§ç»­è¯¦ç»†è®²è§£è¿™ä¸ªçŸ¥è¯†ç‚¹ã€‚';
          step.output = { 
            needMoreExplanation: true,
            message: content
          };
          data = { 
            needMoreExplanation: true
          };
        } else {
          // åˆæ¬¡è¿›å…¥CONFIRMçŠ¶æ€ï¼Œç”ŸæˆçŸ¥è¯†å¤§çº²
          const outlinePrompt = `å­¦ç”Ÿåˆšåˆšå­¦ä¹ äº†"${this.currentSession.topic}"ï¼ˆ${this.currentSession.subject}ï¼‰ï¼Œç°åœ¨éœ€è¦ç”Ÿæˆä¸€ä¸ªçŸ¥è¯†å¤§çº²æ¥å¸®åŠ©å­¦ç”Ÿç¡®è®¤ç†è§£ç¨‹åº¦ã€‚

è¯·ç”Ÿæˆä¸€ä¸ªç»“æ„åŒ–çš„çŸ¥è¯†å¤§çº²ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

## çŸ¥è¯†æ¦‚æ‹¬
ç®€è¦æ¦‚æ‹¬æœ¬çŸ¥è¯†ç‚¹çš„æ ¸å¿ƒå†…å®¹ï¼ˆ50å­—ä»¥å†…ï¼‰

## å…³é”®çŸ¥è¯†ç‚¹
åˆ—å‡º3-5ä¸ªæœ€é‡è¦çš„çŸ¥è¯†ç‚¹

## çŸ¥è¯†æ¡†æ¶
### æ ¸å¿ƒæ¦‚å¿µ
åˆ—å‡º2-3ä¸ªæ ¸å¿ƒæ¦‚å¿µ
### è§£é¢˜æ–¹æ³•  
åˆ—å‡º2-3ä¸ªä¸»è¦è§£é¢˜æ–¹æ³•
### åº”ç”¨åœºæ™¯
åˆ—å‡º2-3ä¸ªå…¸å‹åº”ç”¨åœºæ™¯

## å…¸å‹ä¾‹é¢˜
åˆ—å‡º1-2ä¸ªä»£è¡¨æ€§ä¾‹é¢˜

è¦æ±‚ï¼š
- ä½¿ç”¨Markdownæ ¼å¼
- å†…å®¹è¦å‡†ç¡®ã€å®Œæ•´
- ç»“æ„æ¸…æ™°ï¼Œä¾¿äºç†è§£
- æ§åˆ¶åœ¨400å­—ä»¥å†…
- é‡ç‚¹å†…å®¹ä½¿ç”¨**åŠ ç²—**æ ‡è®°`;

          try {
            content = await this.sendAIMessage(outlinePrompt);
          } catch (error) {
            console.error('[LearningFlowService] ç”ŸæˆçŸ¥è¯†å¤§çº²å‡ºé”™:', error);
            content = `# ${this.currentSession.topic} çŸ¥è¯†å¤§çº²

## çŸ¥è¯†æ¦‚æ‹¬
è¿™æ˜¯å…³äº${this.currentSession.topic}çš„æ ¸å¿ƒçŸ¥è¯†ç‚¹æ¦‚æ‹¬ã€‚

## å…³é”®çŸ¥è¯†ç‚¹
- æ ¸å¿ƒæ¦‚å¿µç†è§£
- åŸºæœ¬åŸç†æŒæ¡
- è§£é¢˜æ–¹æ³•åº”ç”¨

## çŸ¥è¯†æ¡†æ¶
### æ ¸å¿ƒæ¦‚å¿µ
- åŸºç¡€æ¦‚å¿µ
- é‡è¦å®šç†

### è§£é¢˜æ–¹æ³•
- åŸºæœ¬æ–¹æ³•
- è¿›é˜¶æŠ€å·§

### åº”ç”¨åœºæ™¯
- å…¸å‹é¢˜å‹
- å®é™…åº”ç”¨

## å…¸å‹ä¾‹é¢˜
- åŸºç¡€ä¾‹é¢˜
- ç»¼åˆåº”ç”¨é¢˜

è¯·ç¡®è®¤ä½ æ˜¯å¦å·²ç»ç†è§£äº†ä»¥ä¸ŠçŸ¥è¯†ç‚¹å’Œè§£é¢˜æ–¹æ³•ï¼Ÿ`;
          }
          
          step.output = { 
            outline: content,
            confirmationPrompt: 'è¯·ç¡®è®¤ä½ æ˜¯å¦å·²ç»ç†è§£äº†ä»¥ä¸ŠçŸ¥è¯†ç‚¹å’Œè§£é¢˜æ–¹æ³•ï¼Ÿ'
          };
          data = { 
            outline: content,
            showConfirmation: true
          };
          nextState = 'CONFIRM';
        }
        break;

      case 'QUIZ':
        // å¦‚æœç”¨æˆ·è¾“å…¥çš„æ˜¯ç­”æ¡ˆï¼Œåˆ™è¿›è¡Œè¯„åˆ†
        if (this.currentSession.steps.some(s => s.step === 'QUIZ' && s.output.questions)) {
          try {
            // è§£æç”¨æˆ·ç­”æ¡ˆ
            let userAnswers: number[] = [];
            try {
              userAnswers = JSON.parse(userInput);
            } catch (e) {
              // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œå°è¯•å…¶ä»–è§£ææ–¹å¼
              userAnswers = userInput.split(',').map(a => parseInt(a.trim())).filter(n => !isNaN(n));
            }

            // è·å–é¢˜ç›®
            const quizStep = this.currentSession.steps.find(s => s.step === 'QUIZ' && s.output.questions);
            const questions = quizStep?.output.questions || [];
            
            // è®¡ç®—å¾—åˆ†
            let correctCount = 0;
            if (Array.isArray(questions) && questions.length > 0) {
              correctCount = userAnswers.reduce((count, answer, index) => {
                if (index < questions.length && answer === questions[index].correctAnswer) {
                  return count + 1;
                }
                return count;
              }, 0);
            }
            
            const score = questions.length > 0 ? Math.round((correctCount / questions.length) * 100) : 0;
            content = `æµ‹éªŒå®Œæˆï¼ä½ çš„å¾—åˆ†æ˜¯ ${score} åˆ†ã€‚`;
            step.output = { quizResult: { score, correctCount, totalQuestions: questions.length } };
            data = { score, correctCount, totalQuestions: questions.length };
            nextState = 'REVIEW';
          } catch (error) {
            console.error('[LearningSession] æµ‹éªŒè¯„åˆ†å‡ºé”™:', error);
            content = `æµ‹éªŒå®Œæˆï¼ä½ çš„å¾—åˆ†æ˜¯ ${DEFAULT_QUIZ_SCORE} åˆ†ã€‚`;
            step.output = { quizResult: { score: DEFAULT_QUIZ_SCORE } };
            data = { score: DEFAULT_QUIZ_SCORE };
            nextState = 'REVIEW';
          }
        } else {
          // ç”Ÿæˆæµ‹éªŒé¢˜ç›®
          try {
            const questions = await this.generateQuiz(this.currentSession.topic, this.currentSession.subject);
            content = 'æµ‹éªŒé¢˜ç›®å·²ç”Ÿæˆï¼Œè¯·å¼€å§‹ç­”é¢˜ã€‚';
            step.output = { questions };
            data = { questions };
            // ä¿æŒQUIZçŠ¶æ€ï¼Œç­‰å¾…ç”¨æˆ·å›ç­”
          } catch (error) {
            console.error('[LearningSession] ç”Ÿæˆæµ‹éªŒé¢˜ç›®å‡ºé”™:', error);
            // æä¾›é»˜è®¤é¢˜ç›®
            const defaultQuestions = this.generateDefaultQuestions(this.currentSession.topic, this.currentSession.subject);
            content = 'æµ‹éªŒé¢˜ç›®å·²ç”Ÿæˆï¼Œè¯·å¼€å§‹ç­”é¢˜ã€‚';
            step.output = { questions: defaultQuestions };
            data = { questions: defaultQuestions };
          }
        }
        break;

      case 'REVIEW':
        content = `æ­å–œä½ å®Œæˆäº†å…³äº${this.currentSession.topic}çš„å­¦ä¹ ï¼\n\nå­¦ä¹ æ€»ç»“ï¼š\n- ä½ æŒæ¡äº†æ ¸å¿ƒæ¦‚å¿µ\n- èƒ½å¤Ÿåº”ç”¨åˆ°å®é™…é—®é¢˜ä¸­\n- å»ºè®®ç»§ç»­æ·±å…¥å­¦ä¹ ç›¸å…³å†…å®¹`;
        step.output = { review: content };
        nextState = 'DONE';
        break;

      default:
        throw new Error('æœªçŸ¥çš„å­¦ä¹ çŠ¶æ€');
    }

    // æ›´æ–°ä¼šè¯çŠ¶æ€
    this.currentSession.state = nextState;
    this.currentSession.steps.push(step);
    this.currentSession.updatedAt = new Date();

    return { nextState, content, data };
  }

  // è·³è¿‡è¾…å¯¼ï¼Œç›´æ¥è¿›å…¥æµ‹éªŒ
  async skipToQuiz(sessionId: string): Promise<{
    nextState: LearningState;
    content: string;
    data?: any;
  }> {
    console.log('[LearningFlowService] skipToQuiz è¢«è°ƒç”¨ï¼ŒsessionId:', sessionId);
    console.log('[LearningFlowService] currentSession:', this.currentSession);
    
    if (!this.currentSession || this.currentSession.id !== sessionId) {
      console.error('[LearningFlowService] æ— æ•ˆçš„å­¦ä¹ ä¼šè¯');
      throw new Error('æ— æ•ˆçš„å­¦ä¹ ä¼šè¯');
    }

    // è®°å½•è·³è¿‡æ­¥éª¤
    const step: any = {
      id: `step_${Date.now()}`,
      sessionId,
      step: 'QUIZ',
      input: { userInput: 'è·³è¿‡è¾…å¯¼', isSkip: true },
      output: { skipped: true },
      createdAt: new Date()
    };

    try {
      console.log('[LearningFlowService] å¼€å§‹ç”Ÿæˆæµ‹éªŒé¢˜ç›®');
      // ç”Ÿæˆæµ‹éªŒé¢˜ç›®
      const questions = await this.generateQuiz(this.currentSession.topic, this.currentSession.subject);
      console.log('[LearningFlowService] æµ‹éªŒé¢˜ç›®ç”ŸæˆæˆåŠŸ:', questions);
      
      const content = 'æµ‹éªŒé¢˜ç›®å·²ç”Ÿæˆï¼Œè¯·å¼€å§‹ç­”é¢˜ã€‚';
      step.output.questions = questions;

      // æ›´æ–°ä¼šè¯çŠ¶æ€
      this.currentSession.state = 'QUIZ';
      this.currentSession.steps.push(step);
      this.currentSession.updatedAt = new Date();
      console.log('[LearningFlowService] ä¼šè¯çŠ¶æ€å·²æ›´æ–°ä¸º QUIZ');

      return { nextState: 'QUIZ', content, data: { questions } };
    } catch (error) {
      console.error('[LearningFlowService] è·³è¿‡åˆ°æµ‹éªŒæ—¶ç”Ÿæˆé¢˜ç›®å‡ºé”™:', error);
      
      // æä¾›é»˜è®¤é¢˜ç›®
      const defaultQuestions = this.generateDefaultQuestions(this.currentSession.topic, this.currentSession.subject);
      console.log('[LearningFlowService] ä½¿ç”¨é»˜è®¤é¢˜ç›®:', defaultQuestions);
      
      const content = 'æµ‹éªŒé¢˜ç›®å·²ç”Ÿæˆï¼Œè¯·å¼€å§‹ç­”é¢˜ã€‚';
      step.output.questions = defaultQuestions;

      // æ›´æ–°ä¼šè¯çŠ¶æ€
      this.currentSession.state = 'QUIZ';
      this.currentSession.steps.push(step);
      this.currentSession.updatedAt = new Date();
      console.log('[LearningFlowService] ä¼šè¯çŠ¶æ€å·²æ›´æ–°ä¸º QUIZ (ä½¿ç”¨é»˜è®¤é¢˜ç›®)');

      return { nextState: 'QUIZ', content, data: { questions: defaultQuestions } };
    }
  }
}

interface LearningSessionProps {
  savedItems: LearningStep[];
  onExit: () => void;
  onClose?: () => void;
  studentProfile?: StudentProfile;
}

const LearningSessionComponent: React.FC<LearningSessionProps> = ({ savedItems, onExit, onClose, studentProfile }) => {
  const [session, setSession] = useState<LearningSession | null>(null);
  const [currentStep, setCurrentStep] = useState<LearningState>('EXPLAIN');
  const [subject, setSubject] = useState<string>('æ•°å­¦');
  const [topic, setTopic] = useState<string>('');
  const [selectedRegion, setSelectedRegion] = useState<string>('å…¨å›½');
  const [grade, setGrade] = useState<string>('ä¹å¹´çº§');
  const [isInitializing, setIsInitializing] = useState<boolean>(false);
  const [isProcessing, setIsProcessing] = useState<boolean>(false);
  const [stepContent, setStepContent] = useState<string>('');
  const [stepData, setStepData] = useState<any>(null);
  const [currentAnswer, setCurrentAnswer] = useState<string>('');
  const [questionCount, setQuestionCount] = useState<number>(0);
  
  // å¯¹è¯å†å²ç›¸å…³çŠ¶æ€
  const [conversationHistory, setConversationHistory] = useState<ConversationHistory | null>(null);
  
  // ä½¿ç”¨useRefæ¥ä¿å­˜learningServiceå®ä¾‹ï¼Œé¿å…ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ä¸¢å¤±ä¼šè¯çŠ¶æ€
  const learningServiceRef = React.useRef<LearningFlowService>(new LearningFlowService());
  const learningService = learningServiceRef.current;
  
  // å¯¹è¯æœåŠ¡å®ä¾‹
  const conversationService = ConversationService.getInstance();

  // ä»savedItemsä¸­æ™ºèƒ½æå–ä¸»é¢˜å’Œå­¦ç§‘
  const extractTopicAndSubject = (items: LearningStep[]): { topic: string; subject: string } => {
    if (!items || items.length === 0) {
      return { topic: '', subject: 'æ•°å­¦' };
    }

    // å°è¯•ä»ç¬¬ä¸€ä¸ªitemçš„å†…å®¹ä¸­æå–ä¸»é¢˜
    const firstItem = items[0];
    let extractedTopic = '';
    let extractedSubject = 'æ•°å­¦'; // é»˜è®¤å­¦ç§‘

    // æ£€æŸ¥inputä¸­çš„userInput
    if (firstItem.input?.userInput) {
      const content = firstItem.input.userInput;
      
      // æ‰©å±•çš„å­¦ç§‘ä¸»é¢˜æ¨¡å¼åŒ¹é…
      const subjectTopics = {
        'æ•°å­¦': [
          'å…¨ç­‰ä¸‰è§’å½¢', 'ç›¸ä¼¼ä¸‰è§’å½¢', 'ç›´è§’ä¸‰è§’å½¢', 'ç­‰è…°ä¸‰è§’å½¢',
          'äºŒæ¬¡å‡½æ•°', 'ä¸€æ¬¡å‡½æ•°', 'åæ¯”ä¾‹å‡½æ•°', 'æŒ‡æ•°å‡½æ•°', 'å¯¹æ•°å‡½æ•°',
          'åœ†çš„æ€§è´¨', 'åœ†å‘¨è§’', 'åˆ‡çº¿', 'å¼¦é•¿',
          'å¹³è¡Œå››è¾¹å½¢', 'çŸ©å½¢', 'è±å½¢', 'æ­£æ–¹å½¢',
          'æ¦‚ç‡', 'ç»Ÿè®¡', 'æ’åˆ—ç»„åˆ',
          'å¯¼æ•°', 'ç§¯åˆ†', 'æé™',
          'å‘é‡', 'åæ ‡ç³»', 'è§£æå‡ ä½•'
        ],
        'ç”Ÿç‰©': [
          'å†…åˆ†æ³Œç³»ç»Ÿ', 'ç¥ç»ç³»ç»Ÿ', 'å¾ªç¯ç³»ç»Ÿ', 'å‘¼å¸ç³»ç»Ÿ', 'æ¶ˆåŒ–ç³»ç»Ÿ',
          'å…ç–«ç³»ç»Ÿ', 'ç”Ÿæ®–ç³»ç»Ÿ', 'è¿åŠ¨ç³»ç»Ÿ', 'æ³Œå°¿ç³»ç»Ÿ',
          'ç»†èƒç»“æ„', 'ç»†èƒåˆ†è£‚', 'é—ä¼ ', 'DNA', 'RNA', 'è›‹ç™½è´¨',
          'å…‰åˆä½œç”¨', 'å‘¼å¸ä½œç”¨', 'é…¶', 'æ¿€ç´ ', 'åŸºå› ',
          'ç”Ÿæ€ç³»ç»Ÿ', 'é£Ÿç‰©é“¾', 'è¿›åŒ–', 'ç‰©ç§', 'ç”Ÿç‰©å¤šæ ·æ€§'
        ],
        'ç‰©ç†': [
          'åŠ›å­¦', 'ç”µå­¦', 'å…‰å­¦', 'çƒ­å­¦', 'å£°å­¦', 'åŸå­ç‰©ç†',
          'ç‰›é¡¿å®šå¾‹', 'åŠ¨é‡', 'èƒ½é‡', 'åŠŸç‡', 'ç”µæµ', 'ç”µå‹',
          'ç£åœº', 'ç”µç£æ„Ÿåº”', 'æ³¢åŠ¨', 'å¹²æ¶‰', 'è¡å°„',
          'å…‰æ²¿ç›´çº¿ä¼ æ’­', 'å…‰çš„åå°„', 'å…‰çš„æŠ˜å°„', 'å…‰çš„è‰²æ•£',
          'å‡¸é€é•œ', 'å‡¹é€é•œ', 'å¹³é¢é•œ', 'çƒé¢é•œ', 'å…‰çš„å¹²æ¶‰',
          'å…‰çš„è¡å°„', 'å…‰çš„åæŒ¯', 'æ¿€å…‰', 'å…‰çº¤', 'å…‰è°±',
          'é‡åŠ›', 'æ‘©æ“¦åŠ›', 'å¼¹åŠ›', 'å‹å¼º', 'æµ®åŠ›',
          'ç®€è°è¿åŠ¨', 'æœºæ¢°æ³¢', 'å£°æ³¢', 'è¶…å£°æ³¢', 'æ¬¡å£°æ³¢',
          'æ¸©åº¦', 'çƒ­é‡', 'çƒ­ä¼ é€’', 'çƒ­è†¨èƒ€', 'ç›¸å˜',
          'ç”µåœº', 'ç”µåŠ¿', 'ç”µå®¹', 'ç”µé˜»', 'æ¬§å§†å®šå¾‹',
          'äº¤æµç”µ', 'ç›´æµç”µ', 'å˜å‹å™¨', 'å‘ç”µæœº', 'ç”µåŠ¨æœº'
        ],
        'åŒ–å­¦': [
          'åŸå­ç»“æ„', 'åˆ†å­', 'åŒ–å­¦é”®', 'åŒ–å­¦ååº”', 'é…¸ç¢±',
          'æ°§åŒ–è¿˜åŸ', 'æœ‰æœºåŒ–å­¦', 'æ— æœºåŒ–å­¦', 'å…ƒç´ å‘¨æœŸè¡¨',
          'åŒ–å­¦å¹³è¡¡', 'ååº”é€Ÿç‡', 'ç”µåŒ–å­¦'
        ]
      };

      // æŸ¥æ‰¾åŒ¹é…çš„ä¸»é¢˜å’Œå­¦ç§‘
      for (const [subject, topics] of Object.entries(subjectTopics)) {
        for (const topic of topics) {
          if (content.includes(topic)) {
            extractedTopic = topic;
            extractedSubject = subject;
            break;
          }
        }
        if (extractedTopic) break;
      }

      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å…·ä½“ä¸»é¢˜ï¼Œå°è¯•ä»æ ‡é¢˜æˆ–å…³é”®è¯ä¸­æå–
      if (!extractedTopic) {
        // æ›´çµæ´»çš„ä¸»é¢˜æå–æ¨¡å¼
        const patterns = [
          /å­¦ä¹ [ï¼š:]\s*(.+?)(?:\s|$)/,
          /ä¸»é¢˜[ï¼š:]\s*(.+?)(?:\s|$)/,
          /å†…å®¹[ï¼š:]\s*(.+?)(?:\s|$)/,
          /^(.+?)\s*[-â€“â€”]\s*å­¦ä¹ /,
          /^(.+?)\s*å­¦ä¹ /,
          /^(.+?)\s*çš„\s*(.+?)$/,  // åŒ¹é… "ç”Ÿç‰©çš„å†…åˆ†æ³Œç³»ç»Ÿ" æ ¼å¼
          /(.+?)ç³»ç»Ÿ/,  // åŒ¹é…å„ç§ç³»ç»Ÿ
          /(.+?)ä½œç”¨/,  // åŒ¹é…å„ç§ä½œç”¨
          /(.+?)ç»“æ„/   // åŒ¹é…å„ç§ç»“æ„
        ];

        for (const pattern of patterns) {
          const match = content.match(pattern);
          if (match && match[1]) {
            let topic = match[1].trim();
            // å¦‚æœåŒ¹é…åˆ° "ç”Ÿç‰©çš„å†…åˆ†æ³Œç³»ç»Ÿ" è¿™ç§æ ¼å¼ï¼Œæå–åé¢çš„éƒ¨åˆ†
            if (match[2]) {
              topic = match[2].trim();
              // åŒæ—¶è®¾ç½®å­¦ç§‘
              const subjectPart = match[1].trim();
              if (subjectPart.includes('ç”Ÿç‰©')) extractedSubject = 'ç”Ÿç‰©';
              else if (subjectPart.includes('ç‰©ç†')) extractedSubject = 'ç‰©ç†';
              else if (subjectPart.includes('åŒ–å­¦')) extractedSubject = 'åŒ–å­¦';
              else if (subjectPart.includes('æ•°å­¦')) extractedSubject = 'æ•°å­¦';
            }
            extractedTopic = topic;
            break;
          }
        }
      }

      // å¢å¼ºçš„å­¦ç§‘è¯†åˆ«
      if (content.includes('ç”Ÿç‰©') || content.includes('ç»†èƒ') || content.includes('åŸºå› ') || 
          content.includes('å†…åˆ†æ³Œ') || content.includes('ç¥ç»') || content.includes('å¾ªç¯') ||
          content.includes('å‘¼å¸') || content.includes('æ¶ˆåŒ–') || content.includes('å…ç–«') ||
          content.includes('é—ä¼ ') || content.includes('è¿›åŒ–') || content.includes('ç”Ÿæ€')) {
        extractedSubject = 'ç”Ÿç‰©';
      } else if (content.includes('ç‰©ç†') || content.includes('åŠ›å­¦') || content.includes('ç”µå­¦') || 
                 content.includes('å…‰å­¦') || content.includes('å…‰æ²¿') || content.includes('å…‰çš„') ||
                 content.includes('é€é•œ') || content.includes('åå°„') || content.includes('æŠ˜å°„') ||
                 content.includes('ç£åœº') || content.includes('ç”µæµ') || content.includes('ç”µå‹') ||
                 content.includes('é‡åŠ›') || content.includes('æ‘©æ“¦') || content.includes('å‹å¼º') ||
                 content.includes('å£°æ³¢') || content.includes('çƒ­é‡') || content.includes('æ¸©åº¦')) {
        extractedSubject = 'ç‰©ç†';
      } else if (content.includes('æ•°å­¦') || content.includes('å‡ ä½•') || content.includes('ä»£æ•°') || content.includes('å‡½æ•°')) {
        extractedSubject = 'æ•°å­¦';
      } else if (content.includes('åŒ–å­¦') || content.includes('åŸå­') || content.includes('åˆ†å­') || content.includes('ååº”')) {
        extractedSubject = 'åŒ–å­¦';
      } else if (content.includes('è¯­æ–‡') || content.includes('æ–‡å­¦')) {
        extractedSubject = 'è¯­æ–‡';
      } else if (content.includes('è‹±è¯­')) {
        extractedSubject = 'è‹±è¯­';
      }
    }

    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æå–åˆ°ä¸»é¢˜ï¼Œå°è¯•ä»outputä¸­æå–
    if (!extractedTopic && firstItem.output?.explanation) {
      const explanation = firstItem.output.explanation;
      const titleMatch = explanation.match(/^#\s*(.+?)(?:\n|$)/);
      if (titleMatch && titleMatch[1]) {
        extractedTopic = titleMatch[1].trim();
      }
    }

    return { 
      topic: extractedTopic || '', 
      subject: extractedSubject 
    };
  };

  // ç»„ä»¶åˆå§‹åŒ–æ—¶æå–ä¸»é¢˜å’Œå­¦ç§‘
  React.useEffect(() => {
    const { topic: extractedTopic, subject: extractedSubject } = extractTopicAndSubject(savedItems);
    if (extractedTopic) {
      setTopic(extractedTopic);
      setSubject(extractedSubject);
      
      // å¦‚æœæå–åˆ°äº†ä¸»é¢˜ï¼Œè‡ªåŠ¨å¼€å§‹å­¦ä¹ ä¼šè¯
      setTimeout(() => {
        if (extractedTopic.trim()) {
          initializeSession();
        }
      }, 100);
    }
  }, [savedItems]);

  // åˆå§‹åŒ–å­¦ä¹ ä¼šè¯
  const initializeSession = async () => {
    if (!topic.trim()) {
      toast.error('è¯·è¾“å…¥å­¦ä¹ ä¸»é¢˜');
      return;
    }

    setIsInitializing(true);
    try {
      // åˆ›å»ºé»˜è®¤çš„å­¦ä¹ ææ–™ï¼Œç¡®ä¿å³ä½¿æ²¡æœ‰ä¿å­˜çš„å­¦ä¹ ææ–™ä¹Ÿèƒ½ç”Ÿæˆè¯¦ç»†è®²è§£
      let learningMaterials = [{ 
        id: `default_${Date.now()}`,
        content: `è¿™æ˜¯å…³äº${topic}çš„é»˜è®¤å­¦ä¹ ææ–™ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šä½¿ç”¨çœŸå®çš„å­¦ä¹ å†…å®¹ã€‚`,
        subject,
        source: 'default'
      }];
      
      // å¦‚æœæœ‰ä¿å­˜çš„å­¦ä¹ ææ–™ï¼Œä¼˜å…ˆä½¿ç”¨å®ƒä»¬ï¼Œä½†åªä½¿ç”¨ä¸å½“å‰ä¸»é¢˜ç›¸å…³çš„
      if (savedItems && savedItems.length > 0) {
        const allMaterials = savedItems.map(item => ({
          id: item.id,
          content: item.output?.explanation || item.input?.userInput || '',
          subject: subject,
          source: 'saved_items'
        }));
        
        // è¿‡æ»¤ä¸å½“å‰å­¦ä¹ ä¸»é¢˜ç›¸å…³çš„ææ–™ï¼ˆä½¿ç”¨æ›´çµæ´»çš„åŒ¹é…é€»è¾‘ï¼‰
        const relevantMaterials = allMaterials.filter(material => {
          const content = material.content.toLowerCase();
          const topicLower = topic.toLowerCase();
          const subjectLower = subject.toLowerCase();
          
          // 1. ç›´æ¥åŒ…å«å®Œæ•´ä¸»é¢˜åç§°
          if (content.includes(topicLower)) {
            return true;
          }
          
          // 2. åŒ…å«å­¦ç§‘åç§°
          if (content.includes(subjectLower)) {
            return true;
          }
          
          // 3. æ£€æŸ¥ä¸»é¢˜å…³é”®è¯ï¼ˆæ›´çµæ´»çš„åˆ†è¯ï¼‰
          const topicKeywords = topicLower.split(/[\s\-_çš„]+/).filter(word => word.length > 1);
          const hasTopicKeyword = topicKeywords.some(keyword => content.includes(keyword));
          if (hasTopicKeyword) {
            return true;
          }
          
          // 4. æ£€æŸ¥å­¦ç§‘ç›¸å…³å…³é”®è¯
          const subjectKeywords: Record<string, string[]> = {
            'ç”Ÿç‰©': ['ç»†èƒ', 'åŸºå› ', 'é—ä¼ ', 'ç³»ç»Ÿ', 'å™¨å®˜', 'ç»„ç»‡', 'åˆ†å­', 'è›‹ç™½è´¨', 'dna', 'rna', 'æ¿€ç´ ', 'é…¶', 'ä»£è°¢', 'ç”Ÿç†', 'è§£å‰–'],
            'æ•°å­¦': ['å‡½æ•°', 'æ–¹ç¨‹', 'å‡ ä½•', 'ä»£æ•°', 'ä¸‰è§’', 'æ¦‚ç‡', 'ç»Ÿè®¡', 'å¾®ç§¯åˆ†', 'å¯¼æ•°', 'ç§¯åˆ†', 'å‘é‡', 'çŸ©é˜µ'],
            'ç‰©ç†': ['åŠ›', 'èƒ½é‡', 'ç”µ', 'ç£', 'å…‰', 'å£°', 'çƒ­', 'è¿åŠ¨', 'æ³¢', 'åœº', 'ç²’å­', 'åŸå­'],
            'åŒ–å­¦': ['åŸå­', 'åˆ†å­', 'ç¦»å­', 'é”®', 'ååº”', 'å…ƒç´ ', 'åŒ–åˆç‰©', 'æº¶æ¶²', 'é…¸', 'ç¢±', 'æ°§åŒ–', 'è¿˜åŸ']
          };
          
          const keywords = subjectKeywords[subject] || [];
          const hasSubjectKeyword = keywords.some((keyword: string) => content.includes(keyword));
          if (hasSubjectKeyword) {
            return true;
          }
          
          // 5. å¦‚æœæ˜¯ç”¨æˆ·è¾“å…¥çš„ææ–™ï¼Œæ€»æ˜¯åŒ…å«
          if (material.source === 'saved_items' || material.source === 'user_input') {
            return true;
          }
          
          return false;
        });
        
        // å¦‚æœæ‰¾åˆ°ç›¸å…³ææ–™ï¼Œä½¿ç”¨å®ƒä»¬ï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤ææ–™
        if (relevantMaterials.length > 0) {
          learningMaterials = relevantMaterials;
        }
      }
      
      // ä½¿ç”¨é»˜è®¤å­¦ç”ŸIDï¼Œå®é™…åº”ç”¨ä¸­åº”è¯¥ä»ç”¨æˆ·ä¼šè¯ä¸­è·å–
      const studentId = studentProfile?.id || 'default_student';
      const newSession = await learningService.startSession(studentId, subject, topic, learningMaterials);
      setSession(newSession);
      setCurrentStep('EXPLAIN');
      setQuestionCount(0);
      
      // åˆ›å»ºå¯¹è¯å†å²è®°å½•
      const conversationRequest: CreateConversationRequest = {
        type: 'learning',
        subject: subject,
        topic: topic,
        learningSession: newSession,
        initialMessage: {
          role: 'user' as Role,
          content: `å¼€å§‹å­¦ä¹ ${subject}çš„${topic}`
        }
      };
      
      const conversation = await conversationService.findOrCreateLearningConversation(conversationRequest);
      setConversationHistory(conversation);
      
      // ç›´æ¥å¼€å§‹ç¬¬ä¸€æ­¥ï¼Œç”ŸæˆAIè®²è§£å†…å®¹ï¼Œç›´æ¥ä¼ é€’newSessioné¿å…çŠ¶æ€æ›´æ–°å»¶è¿Ÿé—®é¢˜
      await processStep('EXPLAIN', '', newSession);
    } catch (error) {
      toast.error('åˆå§‹åŒ–å­¦ä¹ ä¼šè¯å¤±è´¥');
      console.error(error);
    } finally {
      setIsInitializing(false);
    }
  };

  // å¤„ç†å­¦ä¹ æ­¥éª¤
  const processStep = async (step: LearningState, userInput: string, currentSession?: LearningSession) => {
    const sessionToUse = currentSession || session;
    if (!sessionToUse || !sessionToUse.id) {
      toast.error('æ— æ•ˆçš„å­¦ä¹ ä¼šè¯');
      return;
    }
    
    setIsProcessing(true);
    try {
      // å¦‚æœæœ‰ç”¨æˆ·è¾“å…¥ï¼Œå…ˆä¿å­˜ç”¨æˆ·æ¶ˆæ¯
      if (userInput.trim() && conversationHistory) {
        const userMessage: ChatMessage = {
          role: 'user' as Role,
          content: userInput
        };
        await conversationService.addMessage(conversationHistory.id, userMessage);
      }
      
      const result = await learningService.nextStep(sessionToUse.id, step, userInput);
      setStepContent(result.content);
      setStepData(result.data);
      setCurrentStep(result.nextState);
      
      // ä¿å­˜AIå›å¤åˆ°å¯¹è¯å†å²
      if (result.content && conversationHistory) {
        const assistantMessage: ChatMessage = {
          role: 'assistant' as Role,
          content: result.content
        };
        const updatedConversation = await conversationService.addMessage(conversationHistory.id, assistantMessage);
        if (updatedConversation) {
          setConversationHistory(updatedConversation);
        }
        
        // å¦‚æœæ˜¯EXPLAINæ­¥éª¤çš„åˆå§‹è®²è§£å†…å®¹ï¼Œä¿å­˜åˆ°aiExplanationå­—æ®µ
        if (step === 'EXPLAIN' && !userInput.trim() && result.data?.explanation) {
          await conversationService.updateConversation(conversationHistory.id, {
            aiExplanation: result.data.explanation
          });
        }
      }
      
      // æ›´æ–°ä¼šè¯çŠ¶æ€
      const updatedSession = learningService.getCurrentSession();
      if (updatedSession) {
        setSession(updatedSession);
        // æ›´æ–°é—®é¢˜è®¡æ•°
        setQuestionCount(updatedSession.questionCount || 0);
      }
      
      // å¦‚æœå®Œæˆå­¦ä¹ æµç¨‹
      if (result.nextState === 'DONE') {
        toast.success('æ­å–œå®Œæˆæœ¬æ¬¡å­¦ä¹ ï¼');
        
        // ä¿å­˜å­¦ä¹ å®Œæˆæ¶ˆæ¯
        if (conversationHistory) {
          const completionMessage: ChatMessage = {
            role: 'assistant' as Role,
            content: `ğŸ‰ æ­å–œä½ å®Œæˆäº†${sessionToUse.subject}çš„${sessionToUse.topic}å­¦ä¹ ï¼æœ¬æ¬¡å­¦ä¹ å·²ä¿å­˜åˆ°å¯¹è¯å†å²ä¸­ã€‚`
          };
          await conversationService.addMessage(conversationHistory.id, completionMessage);
        }
      }
    } catch (error) {
      toast.error('å¤„ç†å­¦ä¹ æ­¥éª¤å¤±è´¥: ' + (error as Error).message);
      console.error('å­¦ä¹ æ­¥éª¤å¤„ç†é”™è¯¯:', error);
    } finally {
      setIsProcessing(false);
    }
  };

  // å¤„ç†ç”¨æˆ·è¾“å…¥
  const handleUserInput = async (input: string) => {
    if (!session) return;
    
    // æ ¼å¼åŒ–ç”¨æˆ·è¾“å…¥
    const formattedInput = formatUserInput(input);
    
    setIsProcessing(true);
    try {
      await processStep(currentStep, formattedInput, session);
    } catch (error) {
      toast.error('å¤„ç†ç”¨æˆ·è¾“å…¥å¤±è´¥');
      console.error(error);
    } finally {
      setIsProcessing(false);
    }
  };

  // é€€å‡ºå­¦ä¹ ä¼šè¯
  const handleExit = () => {
    setSession(null);
    setCurrentStep('EXPLAIN');
    setStepContent('');
    setStepData(null);
    setCurrentAnswer('');
    setQuestionCount(0);
    onExit();
  };

  // è·³è¿‡è¾…å¯¼ï¼Œç›´æ¥è¿›å…¥æµ‹éªŒ
  const handleSkipToQuiz = async () => {
    console.log('[LearningSession] handleSkipToQuiz è¢«è°ƒç”¨');
    console.log('[LearningSession] session:', session);
    
    if (!session) {
      console.log('[LearningSession] session ä¸ºç©ºï¼Œè¿”å›');
      return;
    }
    
    console.log('[LearningSession] è®¾ç½® isProcessing ä¸º true');
    setIsProcessing(true);
    try {
      console.log('[LearningSession] è°ƒç”¨ learningService.skipToQuiz');
      const result = await learningService.skipToQuiz(session.id);
      console.log('[LearningSession] skipToQuiz ç»“æœ:', result);
      
      setStepContent(result.content);
      setStepData(result.data);
      setCurrentStep(result.nextState);
      console.log('[LearningSession] çŠ¶æ€å·²æ›´æ–°ä¸º:', result.nextState);
      
      // æ›´æ–°ä¼šè¯çŠ¶æ€
      const updatedSession = learningService.getCurrentSession();
      if (updatedSession) {
        setSession(updatedSession);
        console.log('[LearningSession] ä¼šè¯çŠ¶æ€å·²æ›´æ–°');
      }
      
      toast.success('å·²è·³è¿‡è¾…å¯¼ç¯èŠ‚ï¼Œç›´æ¥è¿›å…¥æµ‹éªŒ');
    } catch (error) {
      console.error('[LearningSession] handleSkipToQuiz é”™è¯¯:', error);
      toast.error('è·³è¿‡è¾…å¯¼å¤±è´¥: ' + (error as Error).message);
    } finally {
      console.log('[LearningSession] è®¾ç½® isProcessing ä¸º false');
      setIsProcessing(false);
    }
  };

  // æ¸²æŸ“å½“å‰æ­¥éª¤
  const renderCurrentStep = () => {
    if (!session) return null;

    switch (currentStep) {
      case 'EXPLAIN':
        return (
          <ExplainStep
            content={stepContent}
            onNext={() => handleUserInput('NEXT_TO_CONFIRM')}
            onAskQuestion={(question: string) => {
              setIsProcessing(true);
              // è°ƒç”¨nextStepæ–¹æ³•ï¼Œä¼ é€’isQuestion=trueæ ‡è¯†è¿™æ˜¯ä¸€ä¸ªæé—®
              learningService.nextStep(session.id, 'EXPLAIN', question, true)
                .then(result => {
                  setStepContent(result.content);
                  setStepData(result.data);
                  setCurrentStep(result.nextState);
                  // ä¿å­˜å½“å‰AIå›ç­”ï¼Œç”¨äºæ˜¾ç¤º
                  setCurrentAnswer(result.content);
                  
                  // æ›´æ–°é—®é¢˜è®¡æ•°
                  const updatedSession = learningService.getCurrentSession();
                  if (updatedSession) {
                    setSession(updatedSession);
                    setQuestionCount(updatedSession.questionCount || 0);
                  }
                })
                .catch(error => {
                  toast.error('æé—®å¤„ç†å¤±è´¥: ' + (error as Error).message);
                  console.error('æé—®å¤„ç†é”™è¯¯:', error);
                })
                .finally(() => {
                  setIsProcessing(false);
                });
            }}
            step={currentStep}
            onSkipToQuiz={handleSkipToQuiz}
            questionCount={questionCount}
            subject={subject}
            topic={topic}
            selectedRegion={selectedRegion}
            grade={grade}
          />
        );
      case 'CONFIRM':
        return (
          <ConfirmStep
            content={stepContent}
            isLoading={isProcessing}
            showConfirmation={stepData?.showConfirmation}
            onConfirmUnderstanding={() => {
              // ç”¨æˆ·ç¡®è®¤ç†è§£ï¼Œè¿›å…¥æµ‹éªŒ
              setIsProcessing(true);
              learningService.nextStep(session.id, 'CONFIRM', 'ç¡®è®¤ç†è§£ï¼Œè¿›è¡Œæµ‹éªŒ')
                .then(result => {
                  setStepContent(result.content);
                  setStepData(result.data);
                  setCurrentStep(result.nextState);
                  toast.success('è¿›å…¥æµ‹éªŒç¯èŠ‚');
                })
                .catch(error => {
                  toast.error('è¿›å…¥æµ‹éªŒå¤±è´¥: ' + (error as Error).message);
                  console.error('è¿›å…¥æµ‹éªŒé”™è¯¯:', error);
                })
                .finally(() => {
                  setIsProcessing(false);
                });
            }}
            onContinueExplanation={() => {
              // ç”¨æˆ·éœ€è¦ç»§ç»­è®²è§£
              setIsProcessing(true);
              learningService.nextStep(session.id, 'CONFIRM', 'ç»§ç»­è®²è§£')
                .then(result => {
                  setStepContent(result.content);
                  setStepData(result.data);
                  setCurrentStep(result.nextState);
                  toast.success('ç»§ç»­ä¸ºä½ è®²è§£');
                })
                .catch(error => {
                  toast.error('ç»§ç»­è®²è§£å¤±è´¥: ' + (error as Error).message);
                  console.error('ç»§ç»­è®²è§£é”™è¯¯:', error);
                })
                .finally(() => {
                  setIsProcessing(false);
                });
            }}
          />
        );
      case 'QUIZ':
        return (
          <QuizStep
            knowledgeContent={stepContent}
            onComplete={(results) => {
              // å¤„ç†æµ‹éªŒå®Œæˆï¼Œè·³è½¬åˆ°ç»“æœé¡µé¢
              setStepData(results);
              setCurrentStep('RESULT' as LearningState);
            }}
            onBack={() => {
              setCurrentStep('EXPLAIN');
            }}
          />
        );
      case 'RESULT':
        return (
          <ResultStep
            key={`result-${Date.now()}`} // å¼ºåˆ¶é‡æ–°æŒ‚è½½ç»„ä»¶ï¼Œç¡®ä¿é‡æ–°è¯„åˆ†
            answers={stepData?.answers || []}
            questions={stepData?.questions || []}
            knowledgeContent={stepContent}
            onRestart={() => setCurrentStep('QUIZ')}
            onContinue={() => setCurrentStep('REVIEW')}
          />
        );
      case 'REVIEW':
        return (
          <ReviewStep
            content={stepContent}
            score={stepData?.score || 0}
            totalQuestions={stepData?.totalQuestions || 1}
            understandingLevel={stepData?.understanding || 3}
            onContinue={handleExit}
            onRestart={() => {
              setSession(null);
              setCurrentStep('EXPLAIN');
              setStepContent('');
              setStepData(null);
              setCurrentAnswer('');
              setQuestionCount(0);
            }}
          />
        );
      default:
        return null;
    }
  };

  return (
    <div className="h-screen bg-gray-900 p-6 overflow-hidden flex flex-col">
      {!session ? (
        <div className="max-w-md mx-auto bg-gray-800 border border-gray-600 rounded-lg p-6">
          <h2 className="text-xl font-bold text-yellow-400 mb-4">å¼€å§‹å­¦ä¹ </h2>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-white mb-1">
                åœ°åŒº
              </label>
              <select
                value={selectedRegion}
                onChange={(e) => setSelectedRegion(e.target.value)}
                className="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white"
              >
                <option value="å…¨å›½">å…¨å›½</option>
                <option value="å¹¿ä¸œ">å¹¿ä¸œ</option>
                <option value="åŒ—äº¬">åŒ—äº¬</option>
                <option value="ä¸Šæµ·">ä¸Šæµ·</option>
                <option value="æ±Ÿè‹">æ±Ÿè‹</option>
                <option value="æµ™æ±Ÿ">æµ™æ±Ÿ</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-white mb-1">
                å¹´çº§
              </label>
              <select
                value={grade}
                onChange={(e) => setGrade(e.target.value)}
                className="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white"
              >
                <option value="ä¸ƒå¹´çº§">ä¸ƒå¹´çº§</option>
                <option value="å…«å¹´çº§">å…«å¹´çº§</option>
                <option value="ä¹å¹´çº§">ä¹å¹´çº§</option>
                <option value="é«˜ä¸€">é«˜ä¸€</option>
                <option value="é«˜äºŒ">é«˜äºŒ</option>
                <option value="é«˜ä¸‰">é«˜ä¸‰</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-white mb-1">
                å­¦ç§‘
              </label>
              <select
                value={subject}
                onChange={(e) => setSubject(e.target.value)}
                className="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white"
              >
                <option value="æ•°å­¦">æ•°å­¦</option>
                <option value="ç‰©ç†">ç‰©ç†</option>
                <option value="åŒ–å­¦">åŒ–å­¦</option>
                <option value="ç”Ÿç‰©">ç”Ÿç‰©</option>
                <option value="å†å²">å†å²</option>
                <option value="åœ°ç†">åœ°ç†</option>
                <option value="è¯­æ–‡">è¯­æ–‡</option>
                <option value="è‹±è¯­">è‹±è¯­</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-white mb-1">
                å­¦ä¹ ä¸»é¢˜
              </label>
              <input
                type="text"
                value={topic}
                onChange={(e) => setTopic(e.target.value)}
                placeholder="è¾“å…¥ä½ æƒ³å­¦ä¹ çš„ä¸»é¢˜"
                className="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white placeholder-gray-400"
              />
            </div>
            <button
              onClick={initializeSession}
              disabled={isInitializing || !topic.trim()}
              className={`w-full py-2 px-4 rounded font-medium ${
                isInitializing || !topic.trim()
                  ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                  : 'bg-yellow-400 text-black hover:bg-yellow-500'
              }`}
            >
              {isInitializing ? 'åˆå§‹åŒ–ä¸­...' : 'å¼€å§‹å­¦ä¹ '}
            </button>
            {onClose && (
              <button
                onClick={onClose}
                className="w-full py-2 px-4 bg-gray-600 text-white rounded hover:bg-gray-700"
              >
                å–æ¶ˆ
              </button>
            )}
          </div>
        </div>
      ) : (
        <div className="max-w-4xl mx-auto flex flex-col h-full">
          <div className="bg-gray-800 border border-gray-600 rounded-lg p-4 mb-4 flex-shrink-0">
            <div className="flex justify-between items-center">
              <h2 className="text-lg font-bold text-yellow-400">
                {session.subject} - {session.topic}
              </h2>
              <button
                onClick={handleExit}
                className="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700"
              >
                é€€å‡º
              </button>
            </div>
            <div className="mt-2 text-sm text-white">
              å½“å‰é˜¶æ®µ: {
                currentStep === 'EXPLAIN' && 'è®²è§£'
                || currentStep === 'CONFIRM' && 'ç¡®è®¤ç†è§£'
                || currentStep === 'QUIZ' && 'æµ‹éªŒ'
                || currentStep === 'REVIEW' && 'å¤ä¹ '
              }
            </div>
          </div>
          <div className="bg-gray-800 border border-gray-600 rounded-lg flex-1 overflow-hidden">
            {renderCurrentStep()}
          </div>
        </div>
      )}
    </div>
  );
};

export default LearningSessionComponent;

// æ·»åŠ ç”¨æˆ·è¾“å…¥æ ¼å¼åŒ–å‡½æ•°
const formatUserInput = (input: string): string => {
  // åŸºæœ¬æ¸…ç†ï¼šå»é™¤é¦–å°¾ç©ºæ ¼ï¼Œè§„èŒƒåŒ–ç©ºæ ¼å­—ç¬¦
  let formatted = input.trim().replace(/\s+/g, ' ');
  
  // ç§»é™¤å¤šä½™çš„æ¢è¡Œç¬¦ï¼ˆä¿ç•™æœ€å¤šä¸¤ä¸ªè¿ç»­æ¢è¡Œç¬¦ï¼‰
  formatted = formatted.replace(/\n{3,}/g, '\n\n');
  
  // ç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼ˆä¿ç•™ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—å’ŒåŸºæœ¬æ ‡ç‚¹ï¼‰
  formatted = formatted.replace(/[^\w\s\u4e00-\u9fff.,!?;:()\-]/g, '');
  
  return formatted;
};
